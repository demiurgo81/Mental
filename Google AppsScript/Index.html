<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        background-color: #f7f9fc;
        color: #1f2933;
        display: grid;
        grid-template-columns: minmax(180px, 240px) 1fr;
        overflow-x: hidden;
      }
      nav {
        background-color: #f4f4f4;
        padding: 20px;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      nav ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      nav li {
        margin: 0;
      }
      nav a {
        text-decoration: none;
        color: #007BFF;
        cursor: pointer;
        font-weight: bold;
        padding: 10px 12px;
        border-radius: 8px;
        transition: background-color 0.2s ease, color 0.2s ease;
        display: block;
      }
      nav a:hover {
        background-color: rgba(0, 123, 255, 0.12);
        color: #0056b3;
      }
      nav a:focus-visible {
        outline: 2px solid #0056b3;
        outline-offset: 2px;
      }
      main {
        padding: 24px;
        background-color: #ffffff;
        box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.04);
        width: 100%;
      }
      #loader {
        display: none; /* Oculto por defecto */
        font-style: italic;
        padding: 12px 20px;
      }

      @media (max-width: 900px) {
        body {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
        }
        nav {
          border-right: none;
          border-bottom: 1px solid #ddd;
          position: sticky;
          top: 0;
          z-index: 20;
          background-color: rgba(244, 244, 244, 0.96);
          backdrop-filter: blur(6px);
        }
        nav ul {
          flex-direction: row;
          flex-wrap: wrap;
        }
        nav a {
          padding: 10px;
        }
        main {
          padding: 18px;
        }
      }

      @media (max-width: 540px) {
        body {
          font-size: 15px;
        }
        nav {
          padding: 16px;
        }
        nav ul {
          gap: 6px;
        }
        nav a {
          flex: 1 1 45%;
          text-align: center;
        }
        main {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>

    <nav>
      <h3>Navegacion</h3>
      <ul>
        <li><a onclick="cargarPagina('inicio')">Inicio</a></li>
        <li><a onclick="cargarPagina('catalogo_sofia1')">Catalogo Sofia</a></li>
        <li><a onclick="cargarPagina('pagina2')">Test Ideologico</a></li>
        <li><a onclick="cargarPagina('pagina1')">Formulario de Pruenbas</a></li>
      </ul>
    </nav>

    <main id="contenido">
      <h2>SOFICREDITOS ONLINE</h2>
      <p>Gestion Financiera del Comportamiento</p>
    </main>

    <div id="loader">Cargando...</div>

    <script>
    
      // --- SECCION 1: LOGICA DE NAVEGACION ---

      /**
       * Inicia la carga de contenido llamando al servidor (Code.gs).
       * @param {string} nombrePagina - El nombre del archivo HTML a cargar (ej. 'pagina1').
       */
      function cargarPagina(nombrePagina) {
        if (nombrePagina === 'inicio') {
          document.getElementById('contenido').innerHTML = 
            '<h2>Bienvenido a la PÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡gina Principal</h2><p>Seleccione una opciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n del menÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Âº de la izquierda para cargar contenido.</p>';
          return;
        }

        mostrarLoader(true);
        google.script.run
          // MODIFICADO: Usar funciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n anÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³nima para pasar nombrePagina al handler
          .withSuccessHandler(function(html) {
            mostrarContenido(html, nombrePagina);
          })
          .withFailureHandler(mostrarError)
          .obtenerContenidoHtml(nombrePagina);
      }

      /**
       * (Success Handler) Inserta el HTML recibido y llama a inicializadores especÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­ficos.
       * @param {string} html - El contenido HTML devuelto por el servidor.
       * @param {string} nombrePagina - El nombre de la pÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡gina que se cargÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³.
       */
      function mostrarContenido(html, nombrePagina) {
        mostrarLoader(false);
        document.getElementById('contenido').innerHTML = html;
        
        // --- ESTA ES LA CLAVE ---
        // DespuÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â©s de cargar el HTML, ejecutar el JS correspondiente.
        if (nombrePagina === 'pagina1') {
          inicializarFormPagina1();
        } else if (nombrePagina === 'pagina2') {
          inicializarPagina2();
        } else if (nombrePagina === 'catalogo_sofia1') {
          inicializarCatalogoSofia();
        }
      }

      /**
       * (Failure Handler) Muestra un error si la llamada a google.script.run falla.
       */
      function mostrarError(error) {
        mostrarLoader(false);
        document.getElementById('contenido').innerHTML = 
          '<p style="color: red;">Error al cargar: ' + error.message + '</p>';
        console.error('Error en google.script.run:', error);
      }

      /**
       * Muestra u oculta un indicador visual de carga.
       */
      function mostrarLoader(mostrar) {
        document.getElementById('loader').style.display = mostrar ? 'block' : 'none';
      }

      
      // --- SECCIÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œN 2: LÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œGICA DEL FORMULARIO DE PÃƒÆ’Ã†â€™Ãƒâ€šÃ‚ÂGINA 1 ---
      // (Este cÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³digo se moviÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³ desde pagina1.html)

      /**
       * Esta funciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n se llama DESPUÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â°S de que pagina1.html se carga.
       */
      function inicializarFormPagina1() {
        // Elementos del DOM (ahora podemos encontrarlos)
        var form = document.getElementById('entryForm');
        var statusMessage = document.getElementById('statusMessage');
        var submitButton = document.getElementById('submitButton');
        var tipoSelect = document.getElementById('tipo');
        var actividadSelect = document.getElementById('actividad');
        var catalogoDatos = {
          tipos: [],
          actividades: {}
        };

        // Evitar doble binding si el usuario navega rÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡pido
        if (form.dataset.initialized) {
          return;
        }
        form.dataset.initialized = 'true';

        function setSelectOptions(selectElement, options, placeholderText, disable) {
          if (!selectElement) {
            return;
          }
          selectElement.innerHTML = '';

          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = placeholderText || 'Selecciona una opcion';
          placeholder.disabled = true;
          placeholder.selected = true;
          selectElement.appendChild(placeholder);

          if (Array.isArray(options)) {
            options.forEach(function(optionValue) {
              var value = String(optionValue || '').trim();
              if (!value) {
                return;
              }

              var option = document.createElement('option');
              option.value = value;
              option.textContent = value;
              selectElement.appendChild(option);
            });
          }

          if (typeof disable === 'boolean') {
            selectElement.disabled = disable;
          } else {
            selectElement.disabled = false;
          }
        }

        function manejarCambioTipo() {
          if (!tipoSelect || !actividadSelect) {
            return;
          }

          var seleccionado = tipoSelect.value;
          if (!seleccionado) {
            setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);
            return;
          }

          var actividades = (catalogoDatos.actividades && catalogoDatos.actividades[seleccionado]) || [];
          if (!actividades.length) {
            setSelectOptions(actividadSelect, [], 'Sin actividades disponibles', true);
            showStatus('No hay actividades disponibles para el tipo seleccionado.', 'error');
            return;
          }

          clearStatus();
          setSelectOptions(actividadSelect, actividades, 'Selecciona una actividad', false);
        }

        function cargarCatalogo() {
          if (!tipoSelect || !actividadSelect) {
            return;
          }

          setSelectOptions(tipoSelect, [], 'Cargando tipos...', true);
          setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);

          google.script.run
            .withSuccessHandler(function(datos) {
              catalogoDatos = datos || { tipos: [], actividades: {} };
              var tipos = Array.isArray(catalogoDatos.tipos) ? catalogoDatos.tipos : [];

              if (!tipos.length) {
                setSelectOptions(tipoSelect, [], 'Sin tipos disponibles', true);
                setSelectOptions(actividadSelect, [], 'Sin actividades disponibles', true);
                showStatus('No hay tipos disponibles en el catalogo.', 'error');
                return;
              }

              setSelectOptions(tipoSelect, tipos, 'Selecciona un tipo', false);
              setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);
            })
            .withFailureHandler(function(error) {
              var mensaje = (error && error.message) ? error.message : 'No se pudo cargar el catalogo.';
              setSelectOptions(tipoSelect, [], 'No disponible', true);
              setSelectOptions(actividadSelect, [], 'No disponible', true);
              showStatus(mensaje, 'error');
            })
            .getCatalogoResumen();
        }

        if (tipoSelect) {
          tipoSelect.addEventListener('change', manejarCambioTipo);
        }

        cargarCatalogo();

        form.addEventListener('submit', function(event) {
          event.preventDefault();
          clearStatus();

          var formData = {
            fecha: document.getElementById('fecha').value,
            usuario: document.getElementById('usuario').value.trim(),
            numero: document.getElementById('numero').value,
            tipo: tipoSelect ? tipoSelect.value : '',
            actividad: actividadSelect ? actividadSelect.value : ''
          };

          if (!isFormValid(formData)) {
            return;
          }

          setLoading(true);

          google.script.run
            .withSuccessHandler(function(message) {
              showStatus(message || 'Registro almacenado correctamente.', 'success');
              alert('Registro enviado con exito');
              form.reset();
              setSelectOptions(
                tipoSelect,
                Array.isArray(catalogoDatos.tipos) ? catalogoDatos.tipos : [],
                'Selecciona un tipo',
                !(catalogoDatos.tipos && catalogoDatos.tipos.length)
              );
              setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);
              setLoading(false);
            })
            .withFailureHandler(function(error) {
              var text = (error && error.message) ? error.message : 'Ocurrio un error al enviar el formulario.';
              showStatus(text, 'error');
              alert(text);
              setLoading(false);
            })
            .submitForma1Entry(formData);
        });
      }

      // --- Funciones auxiliares para el formulario (movidas aquÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­) ---

      function isFormValid(data) {
        if (!data.fecha) {
          showStatus('Selecciona una fecha valida.', 'error');
          return false;
        }
        if (!data.usuario) {
          showStatus('Ingresa un usuario.', 'error');
          return false;
        }
        if (!data.numero) {
          showStatus('Selecciona un numero entre 1 y 5.', 'error');
          return false;
        }
        if (!data.tipo) {
          showStatus('Selecciona un tipo.', 'error');
          return false;
        }
        if (!data.actividad) {
          showStatus('Selecciona una actividad.', 'error');
          return false;
        }
        return true;
      }

      function showStatus(message, type) {
        var statusMessage = document.getElementById('statusMessage');
        if (!statusMessage) return; // Seguridad por si el DOM cambia
        statusMessage.textContent = message;
        statusMessage.className = type === 'success' ? 'success' : 'error';
        statusMessage.style.display = 'block';
      }

      function clearStatus() {
        var statusMessage = document.getElementById('statusMessage');
        if (!statusMessage) return;
        statusMessage.textContent = '';
        statusMessage.className = '';
        statusMessage.style.display = 'none';
      }

      function setLoading(isLoading) {
        var submitButton = document.getElementById('submitButton');
        if (!submitButton) return;
        
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading ? 'Enviando...' : 'Enviar';
        
        // CorrecciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n: No mostrar el status al terminar la carga, 
        // los handlers (showStatus) se encargan de eso.
      }

      // --- SECCIÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œN 3: VISUALIZACIÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œN DE MAPA PARA PÃƒÆ’Ã†â€™Ãƒâ€šÃ‚ÂGINA 2 ---

      // --- SECCION 3: GESTION DEL CATALOGO SOFIA ---

      function inicializarCatalogoSofia() {
        var formulario = document.getElementById('catalogo_sofia');
        if (!formulario) {
          console.warn('No se encontro el formulario catalogo_sofia en el DOM.');
          return;
        }
        if (formulario.dataset.initialized === 'true') {
          return;
        }
        formulario.dataset.initialized = 'true';

        var elementos = {
          modal: document.getElementById('catalogoModal'),
          modalTitulo: document.getElementById('catalogoModalTitulo'),
          filaId: document.getElementById('catalogoRowIndex'),
          tipo: document.getElementById('modalTipo'),
          escenario: document.getElementById('modalEscenario'),
          actividad: document.getElementById('modalActividad'),
          costo: document.getElementById('modalCosto'),
          error: document.getElementById('catalogoModalError'),
          cancelar: document.getElementById('catalogoCancelar'),
          guardar: document.getElementById('catalogoGuardar'),
          filtroTipo: document.getElementById('filterTipo'),
          filtroEscenario: document.getElementById('filterEscenario'),
          filtroBusqueda: document.getElementById('filterSearch'),
          botonNuevo: document.getElementById('btnNuevoCatalogo'),
          tabla: document.getElementById('catalogoTabla'),
          cuerpoTabla: document.getElementById('catalogoTablaBody'),
          vacio: document.getElementById('catalogoEmpty'),
          cargando: document.getElementById('catalogoLoading')
        };

        if (!elementos.modal || !elementos.cuerpoTabla || !elementos.cargando) {
          console.warn('No se pudieron localizar los elementos principales del catalogo.');
          return;
        }

        var estado = {
          registros: [],
          tipos: [],
          filtros: {
            tipo: '',
            escenario: '',
            texto: ''
          }
        };

        function invocarActualizarFormulario() {
          google.script.run
            .withFailureHandler(function(error) {
              var mensaje = (error && error.message) ? error.message : 'No se pudo actualizar el formulario SOFICREDITOS.';
              console.error(mensaje);
            })
            .actualizarFormulario();
        }

        function mostrarCarga(texto) {
          if (!elementos.cargando) {
            return;
          }
          elementos.cargando.hidden = false;
          elementos.cargando.textContent = texto || 'Cargando registros...';
          if (elementos.tabla) {
            elementos.tabla.hidden = true;
          }
          if (elementos.vacio) {
            elementos.vacio.hidden = true;
          }
        }

        function ocultarCarga() {
          if (!elementos.cargando) {
            return;
          }
          elementos.cargando.hidden = true;
        }

        function construirOpciones(select, opciones, placeholder) {
          if (!select) {
            return;
          }
          var fragment = document.createDocumentFragment();
          var opcionBase = document.createElement('option');
          opcionBase.value = '';
          opcionBase.textContent = placeholder;
          fragment.appendChild(opcionBase);

          if (Array.isArray(opciones)) {
            for (var i = 0; i < opciones.length; i++) {
              var valor = opciones[i];
              var opcion = document.createElement('option');
              opcion.value = valor;
              opcion.textContent = valor;
              fragment.appendChild(opcion);
            }
          }

          select.innerHTML = '';
          select.appendChild(fragment);
        }

        function actualizarOpcionesTipo() {
          if (!elementos.filtroTipo) {
            return;
          }
          var seleccionActual = estado.filtros.tipo;
          var opciones = Array.isArray(estado.tipos) ? estado.tipos.slice() : [];
          opciones.sort();
          construirOpciones(elementos.filtroTipo, opciones, 'Todos los tipos');

          if (seleccionActual && opciones.indexOf(seleccionActual) === -1) {
            estado.filtros.tipo = '';
          }
          elementos.filtroTipo.value = estado.filtros.tipo;
        }

        function obtenerEscenariosDisponibles() {
          var base = estado.registros.slice();
          if (estado.filtros.tipo) {
            base = base.filter(function(item) {
              return item && item.tipo === estado.filtros.tipo;
            });
          }
          var mapa = {};
          for (var i = 0; i < base.length; i++) {
            var registro = base[i];
            var valor = registro && registro.escenario;
            if (valor) {
              mapa[valor] = true;
            }
          }
          var lista = Object.keys(mapa);
          lista.sort();
          return lista;
        }

        function actualizarOpcionesEscenario() {
          if (!elementos.filtroEscenario) {
            return;
          }
          var seleccionActual = estado.filtros.escenario;
          var opciones = obtenerEscenariosDisponibles();
          construirOpciones(elementos.filtroEscenario, opciones, 'Todos los escenarios');

          if (seleccionActual && opciones.indexOf(seleccionActual) === -1) {
            estado.filtros.escenario = '';
          }
          elementos.filtroEscenario.value = estado.filtros.escenario;
        }

        function obtenerRegistrosFiltrados() {
          var texto = estado.filtros.texto ? estado.filtros.texto.toLowerCase() : '';
          return estado.registros.filter(function(item) {
            if (!item) {
              return false;
            }
            if (estado.filtros.tipo && item.tipo !== estado.filtros.tipo) {
              return false;
            }
            if (estado.filtros.escenario && item.escenario !== estado.filtros.escenario) {
              return false;
            }
            var desplegable = String(item.desplegable || '').toLowerCase();
            if (texto && desplegable.indexOf(texto) === -1) {
              return false;
            }
            return true;
          });
        }

        function renderTabla() {
          if (!elementos.cuerpoTabla) {
            return;
          }
          var registrosFiltrados = obtenerRegistrosFiltrados();
          elementos.cuerpoTabla.innerHTML = '';

          if (!registrosFiltrados.length) {
            if (elementos.tabla) {
              elementos.tabla.hidden = true;
            }
            if (elementos.vacio) {
              elementos.vacio.hidden = false;
            }
            return;
          }

          if (elementos.tabla) {
            elementos.tabla.hidden = false;
          }
          if (elementos.vacio) {
            elementos.vacio.hidden = true;
          }

          registrosFiltrados.forEach(function(item) {
            var fila = document.createElement('tr');

            var celdaTipo = document.createElement('td');
            celdaTipo.textContent = item.tipo || '';
            fila.appendChild(celdaTipo);

            var celdaEscenario = document.createElement('td');
            celdaEscenario.textContent = item.escenario || '';
            fila.appendChild(celdaEscenario);

            var celdaDesplegable = document.createElement('td');
            celdaDesplegable.textContent = item.desplegable || '';
            fila.appendChild(celdaDesplegable);

            var celdaAcciones = document.createElement('td');
            celdaAcciones.className = 'acciones';

            var contenedor = document.createElement('div');
            contenedor.className = 'tabla-actions';

            var btnEditar = document.createElement('button');
            btnEditar.type = 'button';
            btnEditar.className = 'btn-edit';
            btnEditar.dataset.action = 'editar';
            btnEditar.dataset.rowIndex = String(item.rowIndex);
            btnEditar.textContent = 'Editar';

            var btnEliminar = document.createElement('button');
            btnEliminar.type = 'button';
            btnEliminar.className = 'btn-delete';
            btnEliminar.dataset.action = 'eliminar';
            btnEliminar.dataset.rowIndex = String(item.rowIndex);
            btnEliminar.textContent = 'Eliminar';

            contenedor.appendChild(btnEditar);
            contenedor.appendChild(btnEliminar);
            celdaAcciones.appendChild(contenedor);
            fila.appendChild(celdaAcciones);

            elementos.cuerpoTabla.appendChild(fila);
          });
        }

        function recargarDatos() {
          mostrarCarga('Cargando registros...');
          google.script.run
            .withSuccessHandler(function(respuesta) {
              var registros = respuesta && respuesta.registros;
              var tipos = respuesta && respuesta.tipos;

              estado.registros = Array.isArray(registros) ? registros : [];
              estado.tipos = Array.isArray(tipos) ? tipos.slice() : [];

              actualizarOpcionesTipo();
              actualizarOpcionesEscenario();
              renderTabla();
              ocultarCarga();
            })
            .withFailureHandler(function(error) {
              var mensaje = (error && error.message) ? error.message : 'No se pudieron cargar los registros.';
              mostrarCarga(mensaje);
              console.error('Error al obtener el catalogo:', error);
            })
            .obtenerCatalogoSofiaListado();
        }

        function limpiarErrorModal() {
          if (elementos.error) {
            elementos.error.textContent = '';
            elementos.error.hidden = true;
          }
        }

        function mostrarErrorModal(mensaje) {
          if (elementos.error) {
            elementos.error.textContent = mensaje;
            elementos.error.hidden = false;
          } else {
            alert(mensaje);
          }
        }

        function cerrarModal() {
          if (elementos.modal) {
            elementos.modal.classList.add('hidden');
          }
          formulario.reset();
          limpiarErrorModal();
          if (elementos.filaId) {
            elementos.filaId.value = '';
          }
          if (elementos.tipo) {
            elementos.tipo.disabled = false;
          }
        }

        function aplicarReglaCosto() {
          if (!elementos.tipo || !elementos.costo) {
            return;
          }
          var tipo = elementos.tipo.value;
          var texto = elementos.costo.value;
          if (!texto) {
            return;
          }
          var numero = Number(texto);
          if (!isFinite(numero)) {
            return;
          }
          if (numero % 1 !== 0) {
            return;
          }
          var entero = numero < 0 ? Math.ceil(numero) : Math.floor(numero);
          if (entero === 0) {
            return;
          }
          if (tipo === 'Incentivo') {
            elementos.costo.value = String(Math.abs(entero));
          } else if (tipo) {
            elementos.costo.value = String(-Math.abs(entero));
          } else {
            elementos.costo.value = String(entero);
          }
        }

        function abrirModal(modo, registro) {
          if (!elementos.modal) {
            return;
          }
          limpiarErrorModal();
          elementos.modal.dataset.mode = modo || 'nuevo';

          if (modo === 'editar' && registro) {
            if (elementos.modalTitulo) {
              elementos.modalTitulo.textContent = 'Editar registro';
            }
            if (elementos.filaId) {
              elementos.filaId.value = String(registro.rowIndex || '');
            }
            if (elementos.tipo) {
              elementos.tipo.value = registro.tipo || '';
              elementos.tipo.disabled = true;
            }
            if (elementos.escenario) {
              elementos.escenario.value = registro.escenario || '';
            }
            if (elementos.actividad) {
              elementos.actividad.value = registro.actividad || '';
            }
            if (elementos.costo) {
              elementos.costo.value = registro.costo !== null && registro.costo !== undefined ? registro.costo : '';
            }
          } else {
            if (elementos.modalTitulo) {
              elementos.modalTitulo.textContent = 'Nuevo registro';
            }
            if (elementos.filaId) {
              elementos.filaId.value = '';
            }
            if (elementos.tipo) {
              elementos.tipo.disabled = false;
              elementos.tipo.value = '';
            }
            if (elementos.escenario) {
              elementos.escenario.value = '';
            }
            if (elementos.actividad) {
              elementos.actividad.value = '';
            }
            if (elementos.costo) {
              elementos.costo.value = '';
            }
          }

          elementos.modal.classList.remove('hidden');
          if (modo === 'editar' && elementos.escenario) {
            elementos.escenario.focus();
          } else if (elementos.tipo) {
            elementos.tipo.focus();
          }
          aplicarReglaCosto();
        }

        function prepararPayload() {
          aplicarReglaCosto();

          var tipo = elementos.tipo ? elementos.tipo.value.trim() : '';
          var escenario = elementos.escenario ? elementos.escenario.value.trim() : '';
          var actividad = elementos.actividad ? elementos.actividad.value.trim() : '';
          var costoTexto = elementos.costo ? elementos.costo.value.trim() : '';

          if (!tipo) {
            return { valido: false, mensaje: 'Selecciona un tipo.' };
          }
          if (['Catalogo', 'Incentivo', 'Multa'].indexOf(tipo) === -1) {
            return { valido: false, mensaje: 'El tipo seleccionado no es valido.' };
          }
          if (!escenario) {
            return { valido: false, mensaje: 'Ingresa un escenario.' };
          }
          if (!actividad) {
            return { valido: false, mensaje: 'Ingresa una actividad.' };
          }
          if (!costoTexto) {
            return { valido: false, mensaje: 'Ingresa un costo.' };
          }

          var costoNumero = Number(costoTexto);
          if (!isFinite(costoNumero)) {
            return { valido: false, mensaje: 'El costo debe ser numerico.' };
          }
          if (costoNumero % 1 !== 0) {
            return { valido: false, mensaje: 'El costo debe ser un numero entero.' };
          }
          var costoEntero = costoNumero < 0 ? Math.ceil(costoNumero) : Math.floor(costoNumero);
          if (costoEntero === 0) {
            return { valido: false, mensaje: 'El costo no puede ser cero.' };
          }
          var costoAjustado = costoEntero;
          if (tipo === 'Incentivo') {
            costoAjustado = Math.abs(costoEntero);
          } else {
            costoAjustado = -Math.abs(costoEntero);
          }

          var modo = elementos.modal && elementos.modal.dataset.mode ? elementos.modal.dataset.mode : 'nuevo';
          var payload = {
            tipo: tipo,
            escenario: escenario,
            actividad: actividad,
            costo: costoAjustado
          };

          var fila = elementos.filaId ? Number(elementos.filaId.value) : null;
          if (modo === 'editar') {
            if (!fila || !isFinite(fila)) {
              return { valido: false, mensaje: 'No se pudo identificar el registro que debe actualizarse.' };
            }
            return {
              valido: true,
              modo: 'editar',
              datos: payload,
              rowIndex: fila
            };
          }

          return {
            valido: true,
            modo: 'nuevo',
            datos: payload
          };
        }

        if (elementos.filtroTipo) {
          elementos.filtroTipo.addEventListener('change', function() {
            estado.filtros.tipo = elementos.filtroTipo.value;
            estado.filtros.escenario = '';
            actualizarOpcionesEscenario();
            renderTabla();
          });
        }

        if (elementos.filtroEscenario) {
          elementos.filtroEscenario.addEventListener('change', function() {
            estado.filtros.escenario = elementos.filtroEscenario.value;
            renderTabla();
          });
        }

        if (elementos.filtroBusqueda) {
          elementos.filtroBusqueda.addEventListener('input', function() {
            estado.filtros.texto = elementos.filtroBusqueda.value.trim().toLowerCase();
            renderTabla();
          });
        }

        if (elementos.botonNuevo) {
          elementos.botonNuevo.addEventListener('click', function() {
            abrirModal('nuevo');
          });
        }

        if (elementos.cancelar) {
          elementos.cancelar.addEventListener('click', function() {
            cerrarModal();
          });
        }

        if (elementos.modal) {
          elementos.modal.addEventListener('click', function(event) {
            if (event.target === elementos.modal) {
              cerrarModal();
            }
          });
        }

        if (elementos.tipo) {
          elementos.tipo.addEventListener('change', aplicarReglaCosto);
        }
        if (elementos.costo) {
          elementos.costo.addEventListener('blur', aplicarReglaCosto);
          elementos.costo.addEventListener('input', function() {
            limpiarErrorModal();
          });
        }

        if (elementos.cuerpoTabla) {
          elementos.cuerpoTabla.addEventListener('click', function(event) {
            var boton = event.target.closest('button');
            if (!boton) {
              return;
            }
            var accion = boton.dataset.action;
            var rowIndex = Number(boton.dataset.rowIndex);
            if (!accion || !rowIndex) {
              return;
            }
            var registro = estado.registros.find(function(item) {
              return item && item.rowIndex === rowIndex;
            });
            if (!registro) {
              alert('No se encontro el registro seleccionado.');
              recargarDatos();
              return;
            }

            if (accion === 'editar') {
              abrirModal('editar', registro);
              return;
            }

            if (accion === 'eliminar') {
              var confirmar = confirm('Deseas eliminar el registro seleccionado?');
              if (!confirmar) {
                return;
              }
              google.script.run
                .withSuccessHandler(function() {
                  alert('Registro eliminado.');
                  recargarDatos();
                  invocarActualizarFormulario();
                })
                .withFailureHandler(function(error) {
                  var mensaje = (error && error.message) ? error.message : 'No se pudo eliminar el registro.';
                  alert(mensaje);
                  recargarDatos();
                })
                .eliminarCatalogoSofiaRegistro(rowIndex);
            }
          });
        }

        formulario.addEventListener('submit', function(event) {
          event.preventDefault();
          limpiarErrorModal();

          var resultado = prepararPayload();
          if (!resultado.valido) {
            mostrarErrorModal(resultado.mensaje);
            return;
          }

          if (elementos.guardar) {
            elementos.guardar.disabled = true;
          }
          var textoOriginal = elementos.guardar ? elementos.guardar.textContent : 'Guardar';
          if (elementos.guardar) {
            elementos.guardar.textContent = 'Guardando...';
          }

          var restablecerBoton = function() {
            if (elementos.guardar) {
              elementos.guardar.disabled = false;
              elementos.guardar.textContent = textoOriginal;
            }
          };

          var onSuccess = function() {
            restablecerBoton();
            cerrarModal();
            if (resultado.modo === 'editar') {
              alert('Registro actualizado.');
            } else {
              alert('Registro creado.');
            }
            recargarDatos();
            invocarActualizarFormulario();
          };

          var onError = function(error) {
            restablecerBoton();
            var mensaje = (error && error.message) ? error.message : 'Ocurrio un error al guardar.';
            mostrarErrorModal(mensaje);
          };

          if (resultado.modo === 'editar') {
            google.script.run
              .withSuccessHandler(onSuccess)
              .withFailureHandler(onError)
              .actualizarCatalogoSofiaRegistro(resultado.rowIndex, resultado.datos);
          } else {
            google.script.run
              .withSuccessHandler(onSuccess)
              .withFailureHandler(onError)
              .crearCatalogoSofiaRegistro(resultado.datos);
          }
        });

        recargarDatos();


      }

      // --- SECCION 4: VISUALIZACION DE MAPA PARA PAGINA 2 ---

      var MARKMAP_SCRIPT_SOURCES = [


        'https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js',
        'https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js',
        'https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js',
        'https://cdn.jsdelivr.net/npm/markmap-lib@0.18.12/dist/browser/index.iife.js'
      ];
      var markmapAssetsPromise = null;

      function inicializarPagina2() {
        var container = document.getElementById('mindmap');
        var markdownNode = document.getElementById('pagina2Markdown');
        if (!container || !markdownNode) {
          console.warn('No se encontraron los elementos necesarios para inicializar pagina2.');
          return;
        }

        if (container.dataset.initialized === 'true') {
          return;
        }
        container.dataset.initialized = 'true';

        obtenerMarkmap_().then(function(markmapGlobal) {
          var markdownText = markdownNode.textContent || '';
          if (!markdownText.trim()) {
            console.warn('El contenido markdown para pagina2 estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ vacÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­o.');
            return;
          }

          container.innerHTML = '';

          var Markmap = markmapGlobal.Markmap;
          var Toolbar = markmapGlobal.Toolbar;
          var Transformer = markmapGlobal.Transformer;
          var deriveOptions = markmapGlobal.deriveOptions;

          var transformer = new Transformer();
          var result = transformer.transform(markdownText);
          var frontmatter = result.frontmatter || {};
          var fmOptions = frontmatter.markmap || {};
          var options = typeof deriveOptions === 'function' ? deriveOptions(fmOptions) : fmOptions;

          var mindmap = Markmap.create(container, options || {}, result.root);
          if (mindmap && typeof mindmap.fit === 'function') {
            requestAnimationFrame(function() {
              mindmap.fit();
            });
          }

          limpiarToolbarsPrevias_();
          var toolbar = new Toolbar();
          var toolbarNode = toolbar.render();
          toolbarNode.style.position = 'absolute';
          toolbarNode.style.bottom = '20px';
          toolbarNode.style.right = '20px';
          toolbarNode.dataset.pagina = 'pagina2';
          document.body.appendChild(toolbarNode);
          toolbar.attach(mindmap);

          inicializarModalMarkdown_(markdownText);
        }).catch(function(error) {
          console.error('No fue posible inicializar el mapa mental de pagina2:', error);
        });
      }

      function obtenerMarkmap_() {
        if (window.markmap && window.markmap.Markmap && window.markmap.Toolbar && window.markmap.Transformer) {
          return Promise.resolve(window.markmap);
        }
        if (markmapAssetsPromise) {
          return markmapAssetsPromise;
        }
        markmapAssetsPromise = MARKMAP_SCRIPT_SOURCES.reduce(function(promise, src) {
          return promise.then(function() {
            return cargarScriptUnaVez_(src);
          });
        }, Promise.resolve()).then(function() {
          if (!window.markmap || !window.markmap.Markmap) {
            throw new Error('La librerÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­a markmap no estÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ disponible en window.');
          }
          return window.markmap;
        });
        return markmapAssetsPromise;
      }

      function cargarScriptUnaVez_(src) {
        return new Promise(function(resolve, reject) {
          var existente = document.querySelector('script[src="' + src + '"]');
          if (existente) {
            if (existente.dataset.loaded === 'true') {
              resolve();
              return;
            }
            existente.addEventListener('load', function() {
              existente.dataset.loaded = 'true';
              resolve();
            }, { once: true });
            existente.addEventListener('error', function() {
              reject(new Error('No se pudo cargar ' + src));
            }, { once: true });
            return;
          }

          var script = document.createElement('script');
          script.src = src;
          script.defer = true;
          script.dataset.loaded = 'false';
          script.addEventListener('load', function() {
            script.dataset.loaded = 'true';
            resolve();
          }, { once: true });
          script.addEventListener('error', function() {
            reject(new Error('No se pudo cargar ' + src));
          }, { once: true });
          document.head.appendChild(script);
        });
      }

      function limpiarToolbarsPrevias_() {
        var toolbarNodes = document.querySelectorAll('.markmap-toolbar');
        toolbarNodes.forEach(function(node) {
          if (node.dataset.pagina === 'pagina2') {
            node.remove();
          }
        });
      }

      function inicializarModalMarkdown_(markdownText) {
        var modal = document.getElementById('markdownModal');
        var closeBtn = document.getElementById('closeMarkdownBtn');
        var showBtn = document.getElementById('showMarkdownBtn');
        var viewer = document.getElementById('markdownViewer');
        if (!modal || !closeBtn || !showBtn || !viewer) {
          return;
        }

        viewer.textContent = markdownText;

        if (modal.dataset.initialized === 'true') {
          return;
        }
        modal.dataset.initialized = 'true';

        var openModal = function() {
          modal.classList.add('visible');
        };

        var closeModal = function() {
          modal.classList.remove('visible');
        };

        showBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeModal();
          }
        });
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape' && modal.classList.contains('visible')) {
            closeModal();
          }
        });
      }
    </script>
  </body>
</html>
