<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        background-color: #f7f9fc;
        color: #1f2933;
        display: grid;
        grid-template-columns: minmax(180px, 240px) 1fr;
        overflow-x: hidden;
      }
      nav {
        background-color: #f4f4f4;
        padding: 20px;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      nav ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      nav li {
        margin: 0;
      }
      nav a {
        text-decoration: none;
        color: #007BFF;
        cursor: pointer;
        font-weight: bold;
        padding: 10px 12px;
        border-radius: 8px;
        transition: background-color 0.2s ease, color 0.2s ease;
        display: block;
      }
      nav a:hover {
        background-color: rgba(0, 123, 255, 0.12);
        color: #0056b3;
      }
      nav a:focus-visible {
        outline: 2px solid #0056b3;
        outline-offset: 2px;
      }
      main {
        padding: 24px;
        background-color: #ffffff;
        box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.04);
        width: 100%;
      }
      #loader {
        display: none; /* Oculto por defecto */
        font-style: italic;
        padding: 12px 20px;
      }

      @media (max-width: 900px) {
        body {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
        }
        nav {
          border-right: none;
          border-bottom: 1px solid #ddd;
          position: sticky;
          top: 0;
          z-index: 20;
          background-color: rgba(244, 244, 244, 0.96);
          backdrop-filter: blur(6px);
        }
        nav ul {
          flex-direction: row;
          flex-wrap: wrap;
        }
        nav a {
          padding: 10px;
        }
        main {
          padding: 18px;
        }
      }

      @media (max-width: 540px) {
        body {
          font-size: 15px;
        }
        nav {
          padding: 16px;
        }
        nav ul {
          gap: 6px;
        }
        nav a {
          flex: 1 1 45%;
          text-align: center;
        }
        main {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>

    <nav>
      <h3>Navegacion</h3>
      <ul>
        <li><a onclick="cargarPagina('inicio')">Inicio</a></li>
        <li><a onclick="cargarPagina('pagina1')">Formulario</a></li>
        <li><a onclick="cargarPagina('pagina2')">Test Ideologico</a></li>
      </ul>
    </nav>

    <main id="contenido">
      <h2>Bienvenido a la Página Principal</h2>
      <p>Seleccione una opción del menú de la izquierda para cargar contenido.</p>
    </main>

    <div id="loader">Cargando...</div>

    <script>
    
      // --- SECCIÓN 1: LÓGICA DE NAVEGACIÓN ---

      /**
       * Inicia la carga de contenido llamando al servidor (Code.gs).
       * @param {string} nombrePagina - El nombre del archivo HTML a cargar (ej. 'pagina1').
       */
      function cargarPagina(nombrePagina) {
        if (nombrePagina === 'inicio') {
          document.getElementById('contenido').innerHTML = 
            '<h2>Bienvenido a la Página Principal</h2><p>Seleccione una opción del menú de la izquierda para cargar contenido.</p>';
          return;
        }

        mostrarLoader(true);
        google.script.run
          // MODIFICADO: Usar función anónima para pasar nombrePagina al handler
          .withSuccessHandler(function(html) {
            mostrarContenido(html, nombrePagina);
          })
          .withFailureHandler(mostrarError)
          .obtenerContenidoHtml(nombrePagina);
      }

      /**
       * (Success Handler) Inserta el HTML recibido y llama a inicializadores específicos.
       * @param {string} html - El contenido HTML devuelto por el servidor.
       * @param {string} nombrePagina - El nombre de la página que se cargó.
       */
      function mostrarContenido(html, nombrePagina) {
        mostrarLoader(false);
        document.getElementById('contenido').innerHTML = html;
        
        // --- ESTA ES LA CLAVE ---
        // Después de cargar el HTML, ejecutar el JS correspondiente.
        if (nombrePagina === 'pagina1') {
          inicializarFormPagina1();
        } else if (nombrePagina === 'pagina2') {
          inicializarPagina2();
        }
      }

      /**
       * (Failure Handler) Muestra un error si la llamada a google.script.run falla.
       */
      function mostrarError(error) {
        mostrarLoader(false);
        document.getElementById('contenido').innerHTML = 
          '<p style="color: red;">Error al cargar: ' + error.message + '</p>';
        console.error('Error en google.script.run:', error);
      }

      /**
       * Muestra u oculta un indicador visual de carga.
       */
      function mostrarLoader(mostrar) {
        document.getElementById('loader').style.display = mostrar ? 'block' : 'none';
      }

      
      // --- SECCIÓN 2: LÓGICA DEL FORMULARIO DE PÁGINA 1 ---
      // (Este código se movió desde pagina1.html)

      /**
       * Esta función se llama DESPUÉS de que pagina1.html se carga.
       */
      function inicializarFormPagina1() {
        // Elementos del DOM (ahora podemos encontrarlos)
        var form = document.getElementById('entryForm');
        var statusMessage = document.getElementById('statusMessage');
        var submitButton = document.getElementById('submitButton');
        var tipoSelect = document.getElementById('tipo');
        var actividadSelect = document.getElementById('actividad');
        var catalogoDatos = {
          tipos: [],
          actividades: {}
        };

        // Evitar doble binding si el usuario navega rápido
        if (form.dataset.initialized) {
          return;
        }
        form.dataset.initialized = 'true';

        function setSelectOptions(selectElement, options, placeholderText, disable) {
          if (!selectElement) {
            return;
          }
          selectElement.innerHTML = '';

          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = placeholderText || 'Selecciona una opcion';
          placeholder.disabled = true;
          placeholder.selected = true;
          selectElement.appendChild(placeholder);

          if (Array.isArray(options)) {
            options.forEach(function(optionValue) {
              var value = String(optionValue || '').trim();
              if (!value) {
                return;
              }

              var option = document.createElement('option');
              option.value = value;
              option.textContent = value;
              selectElement.appendChild(option);
            });
          }

          if (typeof disable === 'boolean') {
            selectElement.disabled = disable;
          } else {
            selectElement.disabled = false;
          }
        }

        function manejarCambioTipo() {
          if (!tipoSelect || !actividadSelect) {
            return;
          }

          var seleccionado = tipoSelect.value;
          if (!seleccionado) {
            setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);
            return;
          }

          var actividades = (catalogoDatos.actividades && catalogoDatos.actividades[seleccionado]) || [];
          if (!actividades.length) {
            setSelectOptions(actividadSelect, [], 'Sin actividades disponibles', true);
            showStatus('No hay actividades disponibles para el tipo seleccionado.', 'error');
            return;
          }

          clearStatus();
          setSelectOptions(actividadSelect, actividades, 'Selecciona una actividad', false);
        }

        function cargarCatalogo() {
          if (!tipoSelect || !actividadSelect) {
            return;
          }

          setSelectOptions(tipoSelect, [], 'Cargando tipos...', true);
          setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);

          google.script.run
            .withSuccessHandler(function(datos) {
              catalogoDatos = datos || { tipos: [], actividades: {} };
              var tipos = Array.isArray(catalogoDatos.tipos) ? catalogoDatos.tipos : [];

              if (!tipos.length) {
                setSelectOptions(tipoSelect, [], 'Sin tipos disponibles', true);
                setSelectOptions(actividadSelect, [], 'Sin actividades disponibles', true);
                showStatus('No hay tipos disponibles en el catalogo.', 'error');
                return;
              }

              setSelectOptions(tipoSelect, tipos, 'Selecciona un tipo', false);
              setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);
            })
            .withFailureHandler(function(error) {
              var mensaje = (error && error.message) ? error.message : 'No se pudo cargar el catalogo.';
              setSelectOptions(tipoSelect, [], 'No disponible', true);
              setSelectOptions(actividadSelect, [], 'No disponible', true);
              showStatus(mensaje, 'error');
            })
            .getCatalogoResumen();
        }

        if (tipoSelect) {
          tipoSelect.addEventListener('change', manejarCambioTipo);
        }

        cargarCatalogo();

        form.addEventListener('submit', function(event) {
          event.preventDefault();
          clearStatus();

          var formData = {
            fecha: document.getElementById('fecha').value,
            usuario: document.getElementById('usuario').value.trim(),
            numero: document.getElementById('numero').value,
            tipo: tipoSelect ? tipoSelect.value : '',
            actividad: actividadSelect ? actividadSelect.value : ''
          };

          if (!isFormValid(formData)) {
            return;
          }

          setLoading(true);

          google.script.run
            .withSuccessHandler(function(message) {
              showStatus(message || 'Registro almacenado correctamente.', 'success');
              alert('Registro enviado con exito');
              form.reset();
              setSelectOptions(
                tipoSelect,
                Array.isArray(catalogoDatos.tipos) ? catalogoDatos.tipos : [],
                'Selecciona un tipo',
                !(catalogoDatos.tipos && catalogoDatos.tipos.length)
              );
              setSelectOptions(actividadSelect, [], 'Selecciona una actividad', true);
              setLoading(false);
            })
            .withFailureHandler(function(error) {
              var text = (error && error.message) ? error.message : 'Ocurrio un error al enviar el formulario.';
              showStatus(text, 'error');
              alert(text);
              setLoading(false);
            })
            .submitForma1Entry(formData);
        });
      }

      // --- Funciones auxiliares para el formulario (movidas aquí) ---

      function isFormValid(data) {
        if (!data.fecha) {
          showStatus('Selecciona una fecha valida.', 'error');
          return false;
        }
        if (!data.usuario) {
          showStatus('Ingresa un usuario.', 'error');
          return false;
        }
        if (!data.numero) {
          showStatus('Selecciona un numero entre 1 y 5.', 'error');
          return false;
        }
        if (!data.tipo) {
          showStatus('Selecciona un tipo.', 'error');
          return false;
        }
        if (!data.actividad) {
          showStatus('Selecciona una actividad.', 'error');
          return false;
        }
        return true;
      }

      function showStatus(message, type) {
        var statusMessage = document.getElementById('statusMessage');
        if (!statusMessage) return; // Seguridad por si el DOM cambia
        statusMessage.textContent = message;
        statusMessage.className = type === 'success' ? 'success' : 'error';
        statusMessage.style.display = 'block';
      }

      function clearStatus() {
        var statusMessage = document.getElementById('statusMessage');
        if (!statusMessage) return;
        statusMessage.textContent = '';
        statusMessage.className = '';
        statusMessage.style.display = 'none';
      }

      function setLoading(isLoading) {
        var submitButton = document.getElementById('submitButton');
        if (!submitButton) return;
        
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading ? 'Enviando...' : 'Enviar';
        
        // Corrección: No mostrar el status al terminar la carga, 
        // los handlers (showStatus) se encargan de eso.
      }

      // --- SECCIÓN 3: VISUALIZACIÓN DE MAPA PARA PÁGINA 2 ---

      var MARKMAP_SCRIPT_SOURCES = [
        'https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js',
        'https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js',
        'https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js',
        'https://cdn.jsdelivr.net/npm/markmap-lib@0.18.12/dist/browser/index.iife.js'
      ];
      var markmapAssetsPromise = null;

      function inicializarPagina2() {
        var container = document.getElementById('mindmap');
        var markdownNode = document.getElementById('pagina2Markdown');
        if (!container || !markdownNode) {
          console.warn('No se encontraron los elementos necesarios para inicializar pagina2.');
          return;
        }

        if (container.dataset.initialized === 'true') {
          return;
        }
        container.dataset.initialized = 'true';

        obtenerMarkmap_().then(function(markmapGlobal) {
          var markdownText = markdownNode.textContent || '';
          if (!markdownText.trim()) {
            console.warn('El contenido markdown para pagina2 está vacío.');
            return;
          }

          container.innerHTML = '';

          var Markmap = markmapGlobal.Markmap;
          var Toolbar = markmapGlobal.Toolbar;
          var Transformer = markmapGlobal.Transformer;
          var deriveOptions = markmapGlobal.deriveOptions;

          var transformer = new Transformer();
          var result = transformer.transform(markdownText);
          var frontmatter = result.frontmatter || {};
          var fmOptions = frontmatter.markmap || {};
          var options = typeof deriveOptions === 'function' ? deriveOptions(fmOptions) : fmOptions;

          var mindmap = Markmap.create(container, options || {}, result.root);
          if (mindmap && typeof mindmap.fit === 'function') {
            requestAnimationFrame(function() {
              mindmap.fit();
            });
          }

          limpiarToolbarsPrevias_();
          var toolbar = new Toolbar();
          var toolbarNode = toolbar.render();
          toolbarNode.style.position = 'absolute';
          toolbarNode.style.bottom = '20px';
          toolbarNode.style.right = '20px';
          toolbarNode.dataset.pagina = 'pagina2';
          document.body.appendChild(toolbarNode);
          toolbar.attach(mindmap);

          inicializarModalMarkdown_(markdownText);
        }).catch(function(error) {
          console.error('No fue posible inicializar el mapa mental de pagina2:', error);
        });
      }

      function obtenerMarkmap_() {
        if (window.markmap && window.markmap.Markmap && window.markmap.Toolbar && window.markmap.Transformer) {
          return Promise.resolve(window.markmap);
        }
        if (markmapAssetsPromise) {
          return markmapAssetsPromise;
        }
        markmapAssetsPromise = MARKMAP_SCRIPT_SOURCES.reduce(function(promise, src) {
          return promise.then(function() {
            return cargarScriptUnaVez_(src);
          });
        }, Promise.resolve()).then(function() {
          if (!window.markmap || !window.markmap.Markmap) {
            throw new Error('La librería markmap no está disponible en window.');
          }
          return window.markmap;
        });
        return markmapAssetsPromise;
      }

      function cargarScriptUnaVez_(src) {
        return new Promise(function(resolve, reject) {
          var existente = document.querySelector('script[src="' + src + '"]');
          if (existente) {
            if (existente.dataset.loaded === 'true') {
              resolve();
              return;
            }
            existente.addEventListener('load', function() {
              existente.dataset.loaded = 'true';
              resolve();
            }, { once: true });
            existente.addEventListener('error', function() {
              reject(new Error('No se pudo cargar ' + src));
            }, { once: true });
            return;
          }

          var script = document.createElement('script');
          script.src = src;
          script.defer = true;
          script.dataset.loaded = 'false';
          script.addEventListener('load', function() {
            script.dataset.loaded = 'true';
            resolve();
          }, { once: true });
          script.addEventListener('error', function() {
            reject(new Error('No se pudo cargar ' + src));
          }, { once: true });
          document.head.appendChild(script);
        });
      }

      function limpiarToolbarsPrevias_() {
        var toolbarNodes = document.querySelectorAll('.markmap-toolbar');
        toolbarNodes.forEach(function(node) {
          if (node.dataset.pagina === 'pagina2') {
            node.remove();
          }
        });
      }

      function inicializarModalMarkdown_(markdownText) {
        var modal = document.getElementById('markdownModal');
        var closeBtn = document.getElementById('closeMarkdownBtn');
        var showBtn = document.getElementById('showMarkdownBtn');
        var viewer = document.getElementById('markdownViewer');
        if (!modal || !closeBtn || !showBtn || !viewer) {
          return;
        }

        viewer.textContent = markdownText;

        if (modal.dataset.initialized === 'true') {
          return;
        }
        modal.dataset.initialized = 'true';

        var openModal = function() {
          modal.classList.add('visible');
        };

        var closeModal = function() {
          modal.classList.remove('visible');
        };

        showBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeModal();
          }
        });
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape' && modal.classList.contains('visible')) {
            closeModal();
          }
        });
      }
    </script>
  </body>
</html>
