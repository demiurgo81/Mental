<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="SP_GET_TAREA_ACTIVIDADES/report.js" type="text/javascript"></script>
<link href="SP_GET_TAREA_ACTIVIDADES/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">SP_GET_TAREA_ACTIVIDADES</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#SP_GET_TAREA_ACTIVIDADES">SP_GET_TAREA_ACTIVIDADES</A></B>( P_CODPROYECTO IN NUMBER , P_CODPROVEEDOR IN NUMBER , P_CODPERSONA IN NUMBER , P_FECHAINI IN DATE , P_FECHAFIN IN DATE , P_CURSOR_GET_TAREA_ACTIVIDAD OUT SYS_REFCURSOR , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME="SP_GET_TAREA_ACTIVIDADES"></A>
<H3>SP_GET_TAREA_ACTIVIDADES</H3><PRE>          <B>SP_GET_TAREA_ACTIVIDADES</B>( P_CODPROYECTO IN NUMBER , P_CODPROVEEDOR IN NUMBER , P_CODPERSONA IN NUMBER , P_FECHAINI IN DATE , P_FECHAFIN IN DATE , P_CURSOR_GET_TAREA_ACTIVIDAD OUT SYS_REFCURSOR , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>PDB_CRONUS</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>SP_GET_TAREA_ACTIVIDADES</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>96788</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>17/10/24</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>27/02/25</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2025-02-27:10:20:40</td>
</tr>
<tr>
<td>STATUS</td>
<td>INVALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>N</td>
</tr>
<tr>
<td>DEFAULT_COLLATION</td>
<td>USING_NLS_COMP</td>
</tr>
<tr>
<td>DUPLICATED</td>
<td>N</td>
</tr>
<tr>
<td>SHARDED</td>
<td>N</td>
</tr>
<tr>
<td>CREATED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>CREATED_VSNID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_VSNID</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PROCEDURE SP_GET_TAREA_ACTIVIDADES (
    P_CODPROYECTO IN NUMBER,
    P_CODPROVEEDOR IN NUMBER,
    P_CODPERSONA IN NUMBER,
    P_FECHAINI IN DATE,
    P_FECHAFIN IN DATE,
    P_CURSOR_GET_TAREA_ACTIVIDAD OUT SYS_REFCURSOR,
    V_S_RESPUESTA OUT VARCHAR2,
    V_S_CODIGO OUT NUMBER
)
AS
    -- Declarar una colección para almacenar los resultados
    TYPE TAREA_RECORD_TYPE IS RECORD (
        ID NUMBER,
        FECHAINIREAL DATE,
        FECHAINIESTIMADA DATE,
        FECHAFINREAL DATE,
        FECHAFINESTIMADA DATE,
        CODTAREAPADRE NUMBER,
        CODPROYECTO NUMBER,
        CODEMPLEADOASIGNADO NUMBER,
        CODEMPLEADOCREO NUMBER,
        NOMBRE VARCHAR2(255),
        TIEMPOESTIMADO NUMBER,
        TIEMPOREAL NUMBER,
        CODTAREAESTADO NUMBER,
        CODTAREATIPO NUMBER,
        DURATION NUMBER,
        PARENT NUMBER,
        CODPERSONA NUMBER,
        CODPROVEEDOR NUMBER,
        EMPLEADOASIGNADO VARCHAR2(255),
        NIVEL NUMBER
    );
    
    TYPE TAREA_TABLE_TYPE IS TABLE OF TAREA_RECORD_TYPE;
    TAREA_TABLE TAREA_TABLE_TYPE := TAREA_TABLE_TYPE();

    -- Definir el cursor principal
    CURSOR CURSOR_ACTIVIDADES IS
        SELECT T.ID, T.FECHAINIREAL, T.FECHAINIESTIMADA, T.FECHAFINREAL, T.FECHAFINESTIMADA, T.CODTAREAPADRE,
               T.CODPROYECTO, T.CODEMPLEADOASIGNADO, T.CODEMPLEADOCREO, T.NOMBRE, T.TIEMPOESTIMADO,
               T.TIEMPOREAL, T.CODTAREAESTADO, T.CODTAREATIPO, NVL(T.TIEMPOESTIMADO, 9) / 9 AS DURATION,
               NVL(T.CODTAREAPADRE, T.CODPROYECTO * -1) AS PARENT,
               E.CODPERSONA, E.CODPROVEEDOR, P.NOMCOMPLETO AS EMPLEADOASIGNADO, T.NIVEL
        FROM DF_TAREA T
        INNER JOIN DF_TAREA TF ON TF.ID = T.CODTAREAPADRE
        INNER JOIN DF_EMPLEADO E ON E.ID = T.CODEMPLEADOASIGNADO AND E.VIGENTE = 1
        INNER JOIN DF_PERSONA P ON P.ID = E.CODPERSONA
        WHERE T.ESTADO = 'A'
          AND T.FECHAINIESTIMADA &lt;= TO_DATE('31/10/2024', 'DD/MM/YYYY')
          AND T.FECHAFINESTIMADA >= TO_DATE('01/09/2024', 'DD/MM/YYYY')
          AND T.NIVEL &lt;> 1;

    -- Definir un segundo cursor para manejar las tareas secundarias
    CURSOR CURSOR_TAREAS_SECUNDARIAS (P_CODTAREAPADRE NUMBER) IS
        SELECT T.ID, T.FECHAINIREAL, T.FECHAINIESTIMADA, T.FECHAFINREAL, T.FECHAFINESTIMADA,
               T.CODTAREAPADRE, T.CODPROYECTO, T.CODEMPLEADOASIGNADO, T.CODEMPLEADOCREO,
               T.NOMBRE, T.TIEMPOESTIMADO, T.TIEMPOREAL, T.CODTAREAESTADO,
               T.CODTAREATIPO, NVL(T.TIEMPOESTIMADO, 9) / 9 AS DURATION,
               NVL(T.CODTAREAPADRE, T.CODPROYECTO * -1) AS PARENT, 
               E.CODPERSONA, E.CODPROVEEDOR, P.NOMCOMPLETO AS EMPLEADOASIGNADO, T.NIVEL
        FROM DF_TAREA T
        INNER JOIN DF_EMPLEADO E ON E.ID = T.CODEMPLEADOASIGNADO AND E.VIGENTE = 1
        INNER JOIN DF_PERSONA P ON P.ID = E.CODPERSONA
        WHERE T.ESTADO = 'A' AND T.CODTAREAPADRE = P_CODTAREAPADRE;

    -- Declarar una variable para almacenar los registros del cursor secundario
    TAREA_RECORD TAREA_RECORD_TYPE;

BEGIN
    -- Abrir el cursor principal
    OPEN CURSOR_ACTIVIDADES;

    -- Recorrer el cursor principal y almacenar los resultados en la colección temporal
    LOOP
        FETCH CURSOR_ACTIVIDADES INTO TAREA_RECORD;
        EXIT WHEN CURSOR_ACTIVIDADES%NOTFOUND;
        TAREA_TABLE.EXTEND;
        TAREA_TABLE(TAREA_TABLE.LAST) := TAREA_RECORD;

        -- Procesar las tareas secundarias si el NIVEL es 2
        IF TAREA_RECORD.NIVEL = 2 THEN
            OPEN CURSOR_TAREAS_SECUNDARIAS(TAREA_RECORD.CODTAREAPADRE);

            -- Recorrer el segundo cursor y almacenar los resultados en la colección temporal
            LOOP
                FETCH CURSOR_TAREAS_SECUNDARIAS INTO TAREA_RECORD;
                EXIT WHEN CURSOR_TAREAS_SECUNDARIAS%NOTFOUND;
                
                -- Validar que no se dupliquen las tareas secundarias
                IF NOT EXISTS (SELECT 1 FROM TABLE(TAREA_TABLE) WHERE ID = TAREA_RECORD.ID) THEN
                    TAREA_TABLE.EXTEND;
                    TAREA_TABLE(TAREA_TABLE.LAST) := TAREA_RECORD;
                END IF;
            END LOOP;

            -- Cerrar el segundo cursor
            CLOSE CURSOR_TAREAS_SECUNDARIAS;
        END IF;
    END LOOP;

    -- Cerrar el cursor principal
    CLOSE CURSOR_ACTIVIDADES;

    -- Abrir el cursor de salida con los resultados combinados
    OPEN P_CURSOR_GET_TAREA_ACTIVIDAD FOR
        SELECT * FROM TABLE(TAREA_TABLE);

    -- Configurar valores de respuesta
    V_S_RESPUESTA := 'Consulta ejecutada correctamente';
    V_S_CODIGO := 0;

EXCEPTION
    WHEN OTHERS THEN
        V_S_RESPUESTA := 'Error al ejecutar la consulta: ' || SQLERRM;
        V_S_CODIGO := -1;
END SP_GET_TAREA_ACTIVIDADES;</pre>
</div>
</div>
</div>
</body>
</html>
