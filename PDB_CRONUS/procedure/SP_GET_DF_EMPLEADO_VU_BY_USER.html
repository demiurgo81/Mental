<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="SP_GET_DF_EMPLEADO_VU_BY_USER/report.js" type="text/javascript"></script>
<link href="SP_GET_DF_EMPLEADO_VU_BY_USER/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">SP_GET_DF_EMPLEADO_VU_BY_USER</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#"SP_GET_DF_EMPLEADO_VU_BY_USER"">"SP_GET_DF_EMPLEADO_VU_BY_USER"</A></B>( P_USUARIO IN VARCHAR2 , P_CURSOR_DF_EMPLEADO_VU_BY_USER OUT SYS_REFCURSOR , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME=""SP_GET_DF_EMPLEADO_VU_BY_USER""></A>
<H3>"SP_GET_DF_EMPLEADO_VU_BY_USER"</H3><PRE>          <B>"SP_GET_DF_EMPLEADO_VU_BY_USER"</B>( P_USUARIO IN VARCHAR2 , P_CURSOR_DF_EMPLEADO_VU_BY_USER OUT SYS_REFCURSOR , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>PDB_CRONUS</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>SP_GET_DF_EMPLEADO_VU_BY_USER</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>100321</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>16/05/25</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>16/05/25</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2025-05-16:10:38:17</td>
</tr>
<tr>
<td>STATUS</td>
<td>VALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>N</td>
</tr>
<tr>
<td>DEFAULT_COLLATION</td>
<td>USING_NLS_COMP</td>
</tr>
<tr>
<td>DUPLICATED</td>
<td>N</td>
</tr>
<tr>
<td>SHARDED</td>
<td>N</td>
</tr>
<tr>
<td>CREATED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>CREATED_VSNID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_VSNID</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PROCEDURE "SP_GET_DF_EMPLEADO_VU_BY_USER" (
    P_USUARIO IN VARCHAR2,
    P_CURSOR_DF_EMPLEADO_VU_BY_USER OUT SYS_REFCURSOR,
    V_S_RESPUESTA OUT VARCHAR2,
    V_S_CODIGO OUT NUMBER
)
AS
    V_IDROL NUMBER := NULL;
BEGIN
    BEGIN
        
        
        --IF P_USUARIO IS NULL OR TRIM(P_USUARIO) = '' THEN
            
        --END IF;
        
    
        OPEN P_CURSOR_DF_EMPLEADO_VU_BY_USER FOR
            WITH jerarquias AS (
              SELECT 
                eo.id AS eo_id,
                eo.jerarquia,
                TO_NUMBER(SUBSTR(eo.jerarquia,1,10)) AS id1,
                TO_NUMBER(SUBSTR(eo.jerarquia,11,10)) AS id2,
                TO_NUMBER(SUBSTR(eo.jerarquia,21,10)) AS id3,
                TO_NUMBER(SUBSTR(eo.jerarquia,31,10)) AS id4
              FROM DF_ESTRUCTURAORGANIZACIONAL eo
            ),
            estructuras_gerencia AS (
              SELECT j.eo_id,
                     eo_gere.CODEMPLEADO_RESPONSABLE AS codempleado_gere,
                     eo_gere.NOMBRE AS nombre_gere
              FROM jerarquias j
              LEFT JOIN DF_ESTRUCTURAORGANIZACIONAL eo_gere
                ON eo_gere.ID IN (j.id1, j.id2, j.id3, j.id4)
               AND eo_gere.CODESTRUCTURATIPO = 1
            ),
            estructuras_coord AS (
              SELECT j.eo_id,
                     eo_coord.CODEMPLEADO_RESPONSABLE AS codempleado_coord,
                     eo_coord.NOMBRE AS nombre_coord
              FROM jerarquias j
              LEFT JOIN DF_ESTRUCTURAORGANIZACIONAL eo_coord
                ON eo_coord.ID IN (j.id1, j.id2, j.id3, j.id4)
               AND eo_coord.CODESTRUCTURATIPO = 2
            ),
            persona_empleado AS (
              SELECT 
                e.ID AS CODEMPLEADO,
                TRIM(REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        TRANSLATE(UPPER(p.NOMBRE1 || ' ' || p.NOMBRE2 || ' ' || p.APELLIDO1 || ' ' || p.APELLIDO2),
                                  'ÁÉÍÓÚáéíóúñü',
                                  'AEIOUaeiounu'),
                        '[^A-Z0-9\ \-]+', ''), '[\ ]+', ' ')
                ) AS NOMBRE_NORMALIZADO
              FROM DF_EMPLEADO e
              JOIN DF_PERSONA p ON p.ID = e.CODPERSONA
            )

            SELECT 
              rownum id,
              E.ID CODEMPLEADO,
              P.ID CODPERSONA,
              P.NOMCOMPLETO AS NOMBRE,
              P.CODTIPODOCUMENTO,
              TD.NOMBRE AS TIPODOCUMENTO,
              P.NUMERODOCUMENTO,
              P.NOMBRE1, 
              P.NOMBRE2,
              P.APELLIDO1,
              P.APELLIDO2,
              P.TELEFONO,
              P.CORREO,
              P.DIRECCIONRESIDENCIA,
              P.GENERO,
              CASE WHEN P.GENERO = 'M' THEN 'Masculino' 
                   WHEN P.GENERO = 'F' THEN 'Femenino' 
              END GENERONOMBRE,
              P.FECHANACIMIENTO,
              E.CODPERFIL,
              DPER.NOMBRE AS PERFIL,
              E.CODPERFILTIPO,
              DPERT.NOMBRE PERFILTIPO,
              E.CODLINEAPRODUCTO,
              LP.NOMBRE AS LINEAPRODUCTO,
              E.CODPROVEEDOR,
              PRO.NOMBRE AS PROVEEDOR,
              E.CODPERFILNIVEL,
              PERNIV.NOMBRE AS PERFILNIVEL,
              E.USUARIOCLARO,
              E.FECHAINICIO,
              E.FECHAFIN,
              E.CODESTRUCTURAORGANIZACIONAL,
              EO.NOMBRE ESTRUCTURAORGANIZACIONAL,
              EO.CODESTRUCTURATIPO CODTIPOESTRUCTURA,
              EST.NOMBRE AS TIPOESTRUCTURA,
              EO.JERARQUIA,
              EO.CODEMPLEADO_RESPONSABLE CODEMPLEADOLIDER,
              LEAD.NOMBRE_NORMALIZADO AS LEAD,
              U.TOKENAZURE,
              U.AZUREEMAIL,
              UR.CODUSUARIOROL AS ROL,
              E.CODMODALIDAD,
              CASE E.CODMODALIDAD WHEN 1 THEN 'OPEX' ELSE 'CAPEX' END MODALIDAD,
              E.CELULA,
              UPPER(PROY.NOMBRE) CELFIJA,
              E.VIGENTE,
              CE.COSTO_PUNTO VALOR,
              CE.COSTO_MES VALORMES,
              CE.COSTO_PUNTO,
              CE.COSTO_MES,
              CE.UNIDADES PUNTOS_MES,
              CE.FACTOR_UNIDAD FACTOR_PUNTO,
              CE.MODALIDAD CMODALIDAD,
              CE.DESDE COSTO_DESDE,
              NVL(CE.HASTA,SYSDATE+365) COSTO_HASTA,
              pe_gere.NOMBRE_NORMALIZADO AS GERE,
              pe_coord.NOMBRE_NORMALIZADO AS CORD,
              SUBSTR(eo.jerarquia,0,10)*1 codGER,
              SUBSTR(eo.jerarquia,11,10)*1 codCOR,
              estructuras_gerencia.nombre_gere AS GER,
              estructuras_coord.nombre_coord AS COR

            FROM DF_EMPLEADO E
                LEFT JOIN DF_PERSONA P ON P.ID = E.CODPERSONA
                LEFT JOIN DF_USUARIO U ON U.CODPERSONA = E.CODPERSONA AND U.ESTADO = 'A'
                LEFT JOIN DF_USUARIO_ROLES UR ON U.ID = UR.CODUSUARIO 
                LEFT JOIN DF_ESTRUCTURAORGANIZACIONAL EO ON EO.ID = E.CODESTRUCTURAORGANIZACIONAL
                LEFT JOIN DF_COSTO_EMPLEADO CE ON CE.CODEMPLEADO = E.ID AND CE.VIGENTE = 1
                LEFT JOIN DF_TIPODOCUMENTO TD ON TD.ID = P.CODTIPODOCUMENTO
                LEFT JOIN DF_PERFIL DPER ON DPER.ID = E.CODPERFIL
                LEFT JOIN DF_PERFILTIPO DPERT ON DPERT.ID = E.CODPERFILTIPO
                LEFT JOIN DF_LINEASPRODUCTO LP ON LP.ID = E.CODLINEAPRODUCTO
                LEFT JOIN DF_PROVEEDOR PRO ON PRO.ID = E.CODPROVEEDOR
                LEFT JOIN DF_ESTRUCTURATIPO EST ON EST.ID = eo.codestructuratipo
                LEFT JOIN DF_PERFILNIVEL PERNIV ON PERNIV.ID = E.CODPERFILNIVEL
                LEFT JOIN DF_PROYECTO PROY ON PROY.ID = E.CELULA
                -- joins con los CTEs
                LEFT JOIN estructuras_gerencia ON estructuras_gerencia.eo_id = eo.id
                LEFT JOIN estructuras_coord ON estructuras_coord.eo_id = eo.id
                LEFT JOIN persona_empleado pe_gere ON pe_gere.CODEMPLEADO = estructuras_gerencia.codempleado_gere
                LEFT JOIN persona_empleado pe_coord ON pe_coord.CODEMPLEADO = estructuras_coord.codempleado_coord
                LEFT JOIN persona_empleado LEAD ON LEAD.CODEMPLEADO = EO.CODEMPLEADO_RESPONSABLE

            WHERE UR.CODUSUARIOROL IS NULL OR UR.CODUSUARIOROL &lt;> 3;
        V_S_CODIGO := 200;
        V_S_RESPUESTA := 'Retorno de datos completo ';
    EXCEPTION
        WHEN OTHERS THEN
            V_S_CODIGO := 500;
            V_S_RESPUESTA := 'Error: ' || SQLERRM;
    END;
END SP_GET_DF_EMPLEADO_VU_BY_USER;</pre>
</div>
</div>
</div>
</body>
</html>
