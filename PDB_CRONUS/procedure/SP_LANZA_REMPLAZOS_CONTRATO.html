<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="SP_LANZA_REMPLAZOS_CONTRATO/report.js" type="text/javascript"></script>
<link href="SP_LANZA_REMPLAZOS_CONTRATO/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">SP_LANZA_REMPLAZOS_CONTRATO</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#"SP_LANZA_REMPLAZOS_CONTRATO"">"SP_LANZA_REMPLAZOS_CONTRATO"</A></B>( contrato in number ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME=""SP_LANZA_REMPLAZOS_CONTRATO""></A>
<H3>"SP_LANZA_REMPLAZOS_CONTRATO"</H3><PRE>          <B>"SP_LANZA_REMPLAZOS_CONTRATO"</B>( contrato in number ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>PDB_CRONUS</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>SP_LANZA_REMPLAZOS_CONTRATO</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>80327</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>13/07/22</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>16/07/24</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2024-07-16:09:28:34</td>
</tr>
<tr>
<td>STATUS</td>
<td>INVALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>N</td>
</tr>
<tr>
<td>DEFAULT_COLLATION</td>
<td>USING_NLS_COMP</td>
</tr>
<tr>
<td>DUPLICATED</td>
<td>N</td>
</tr>
<tr>
<td>SHARDED</td>
<td>N</td>
</tr>
<tr>
<td>CREATED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>CREATED_VSNID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_VSNID</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PROCEDURE "SP_LANZA_REMPLAZOS_CONTRATO" (contrato in number)
as
 D_CONTRATO NUMBER(15);
 V_INI_CONTRC NUMBER(15);
 V_IDB_CONTRC NUMBER(15);
 v_contrato varchar2(50);
 v_entrega varchar2(10);
 v_idopera number(15);
 v_f_ini_ope date;
 v_f_instala date;
 v_FECHA_NOVEDAD date;
 begin
    D_CONTRATO := contrato;
    UPDATE MINTIC_BENIF SET ASIGNADO =0 WHERE CONTRATO = D_CONTRATO;
    COMMIT;
    --VERIFICA QUE LOS IDS EXISTENTES YA ESTEN ASIGNADOS.
    BEGIN 
      FOR E IN (
        SELECT CC.ROWID IDT,
            BB.CUENTA,
            BB.ID_BENEFICIARIO,
            to_number(BB.CONTR_APOR_MINTIC) CONTR_APOR_MINTIC
          FROM MINTIC_OPERACIONES_ODI BB
          INNER JOIN MINTIC_BENIF CC
          ON CC.CONTRATO = to_number(BB.CONTR_APOR_MINTIC) and CC.ID_BENEFICIARIO = BB.ID_BENEFICIARIO
          WHERE BB.ID_BENEFICIARIO IS NOT NULL
        AND to_number(BB.CONTR_APOR_MINTIC) = D_CONTRATO
        ) LOOP
            update MINTIC_BENIF set ASIGNADO = 1 WHERE ROWID = E.IDT;
          END LOOP;
          COMMIT;
    END;
    --ASIGNA ID'S A LOS APROBADOS SI EL CONTRATO CUENTA CON CUPOS.
    BEGIN
          FOR A IN (
              SELECT ROWID IDT,
                ID_BENEFICIARIO,
                to_number(CONTR_APOR_MINTIC) CONTR_APOR_MINTIC
              FROM MINTIC_OPERACIONES_ODI 
              WHERE ESTADO_FONTIC = 'APROBADO'
              AND NVL(ID_BENEFICIARIO,0) &lt;=0
              AND to_number(CONTR_APOR_MINTIC) = D_CONTRATO
              ORDER BY ESTADO,FECHA_INI_OPERA asc
            ) LOOP

              BEGIN
                EXECUTE IMMEDIATE 'SELECT ID_BENIF ,ID_BENEFICIARIO FROM (
                  SELECT ROWNUM IDDT,ID_BENIF,ID_BENEFICIARIO FROM(
                  SELECT ID_BENEFICIARIO,ID_MINTIC_BENIF ID_BENIF FROM MINTIC_BENIF WHERE ASIGNADO =0 AND CONTRATO = :D_CONTRATO
                  ORDER BY ID_BENEFICIARIO)) WHERE IDDT =1' INTO V_IDB_CONTRC,V_INI_CONTRC USING D_CONTRATO;
                EXCEPTION 
                  WHEN NO_DATA_FOUND THEN
                    V_INI_CONTRC := NULL;
              END;
              IF V_INI_CONTRC IS NOT NULL THEN
                UPDATE MINTIC_OPERACIONES_ODI set ID_BENEFICIARIO = V_INI_CONTRC where rowid = A.IDT;
                UPDATE MINTIC_BENIF SET ASIGNADO = 2,FECHA_MODIFICACION = sysdate WHERE ID_MINTIC_BENIF = V_IDB_CONTRC;
              END IF;

          END LOOP;
          COMMIT;
    END;
    --RETIRAR CUENTAS
    BEGIN FOR A IN(          
     SELECT  
                ROWID IDT,
                FECHA_RETIRO
                FROM MINTIC_OPERACIONES_ODI
     WHERE
     ESTADO = 'INACTIVO'
     AND NVL(NOVEDAD,'-') NOT IN ('RETIRO')
     AND FECHA_RETIRO IS NOT NULL
     AND ID_BENEFICIARIO IS NOT NULL
     AND CONTR_APOR_MINTIC = D_CONTRATO
     AND REMPLAZO IS NULL) LOOP
      UPDATE MINTIC_OPERACIONES_ODI
      SET NOVEDAD = 'RETIRO', FECHA_NOVEDAD = A.FECHA_RETIRO, REMPLAZO = 'S' WHERE ROWID = A.IDT ;
    END LOOP;
    COMMIT;
    END;
    begin
       DBMS_OUTPUT.PUT_LINE('asigna datos'); 
       for dta in (
         SELECT  
                ROWID ID_OPERACIONES,
                ID_BENEFICIARIO,
                CIUDAD,
                CUENTA,
                COD_DANE_CIUDAD,
                CONTR_APOR_MINTIC,
                FECHA_NOVEDAD,
                ESTADO_FONTIC,
                FECHA_INI_OPERA,
                FECHA_RETIRO,
                FECHA_INSTALACION
                FROM MINTIC_OPERACIONES_ODI
     WHERE
     /*ESTADO = 'INACTIVO'
     AND FECHA_RETIRO IS NOT NULL
     AND ID_BENEFICIARIO IS NOT NULL
     AND*/
     REMPLAZO = 'S'
     AND CONTR_APOR_MINTIC = D_CONTRATO
      ORDER BY FECHA_RETIRO ASC
      ) LOOP
       v_idopera :=0;
       v_f_ini_ope := null;
       v_f_instala := null;
       v_FECHA_NOVEDAD := null;
       --D_CONTRATO := dta.CONTR_APOR_MINTIC;
       --1.Fecha igual.
       begin
          EXECUTE IMMEDIATE '
            SELECT CUENTA,FECHA_INI_OPERA ,FECHA_INSTALACION
            FROM (
              select ROWNUM IDT,CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION,COD_DANE_CIUDAD from (
                SELECT /*+RULE*/ CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION,COD_DANE_CIUDAD
                FROM MINTIC_OPERACIONES_ODI
                WHERE to_number(CONTR_APOR_MINTIC) = :D_CONTRATO
                AND NVL(ID_BENEFICIARIO,0) &lt;=0
                AND estado = ''ACTIVO''
                AND LEGALIZADO =''LEGALIZADO''
                AND ESTADO_FONTIC IS NULL
                AND trunc(FECHA_INSTALACION) = trunc(:FECHA_RETIRO)
                UNION ALL
                SELECT /*+RULE*/ CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION,COD_DANE_CIUDAD
                FROM MINTIC_OPERACIONES_ODI
                WHERE to_number(CONTR_APOR_MINTIC) = :D_CONTRATO
                AND NVL(ID_BENEFICIARIO,0) &lt;=0
                AND estado = ''ACTIVO''
                AND ESTADO_FONTIC =''APROBADO''
                AND trunc(FECHA_INSTALACION) = trunc(:FECHA_RETIRO)
              )
            ) WHERE IDT = 1
          ' INTO v_idopera,v_f_ini_ope,v_f_instala USING D_CONTRATO, dta.FECHA_RETIRO,D_CONTRATO, dta.FECHA_RETIRO;
       EXCEPTION
          WHEN NO_DATA_FOUND then
            v_idopera :=0;
       end;
            DBMS_OUTPUT.PUT_LINE('v_idopera'); 
        if v_idopera >=1 then
        --validacion fecha novedad
        v_f_ini_ope := v_f_instala+1;
        if dta.FECHA_RETIRO is not null then
          if v_f_ini_ope &lt; dta.FECHA_RETIRO then
            v_FECHA_NOVEDAD := (dta.FECHA_RETIRO+1);
            v_f_ini_ope := (dta.FECHA_RETIRO+1);
          end if;
          if v_f_ini_ope > dta.FECHA_RETIRO then
            v_FECHA_NOVEDAD := v_f_ini_ope;
          end if;
        end if;

        if v_FECHA_NOVEDAD is null then
          if v_f_ini_ope &lt; dta.FECHA_RETIRO then
            v_FECHA_NOVEDAD := (dta.FECHA_RETIRO+1);
          else 
            v_FECHA_NOVEDAD := v_f_ini_ope;
          end if; 
        end if;

        update MINTIC_OPERACIONES_ODI set ID_BENEFICIARIO = dta.ID_BENEFICIARIO ,NOVEDAD='INGRESO',FECHA_NOVEDAD= v_FECHA_NOVEDAD,FECHA_INI_OPERA = v_f_ini_ope where CUENTA = v_idopera;
        COMMIT;
        --update MINTIC_OPERACIONES_ODI set NOVEDAD='RETIRO', FECHA_NOVEDAD = dta.FECHA_RETIRO where ROWID =dta.ID_OPERACIONES;
       else
            --3.fecha mayor mas cercana
            begin
              EXECUTE IMMEDIATE '
                SELECT CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION
                FROM (
                  select ROWNUM IDT,CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION,COD_DANE_CIUDAD from (
                    SELECT * FROM (
                    SELECT /*+RULE*/ CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION,COD_DANE_CIUDAD
                    FROM MINTIC_OPERACIONES_ODI
                    WHERE to_number(CONTR_APOR_MINTIC) = :D_CONTRATO
                    AND NVL(ID_BENEFICIARIO,0) &lt;=0
                    AND estado = ''ACTIVO''
                    AND ESTADO_FONTIC =''APROBADO''
                    AND FECHA_INSTALACION >= (:FECHA_RETIRO)
                    AND trunc(FECHA_INSTALACION) >= trunc(:FECHA_RETIRO)
                    UNION ALL
                    SELECT /*+RULE*/ CUENTA,FECHA_INI_OPERA,FECHA_INSTALACION,COD_DANE_CIUDAD
                    FROM MINTIC_OPERACIONES_ODI
                    WHERE to_number(CONTR_APOR_MINTIC) = :D_CONTRATO
                    AND NVL(ID_BENEFICIARIO,0) &lt;=0
                    AND estado = ''ACTIVO''
                    AND LEGALIZADO = ''LEGALIZADO''
                    AND ESTADO_FONTIC IS NULL
                    AND FECHA_INSTALACION >= (:FECHA_RETIRO )
                    AND trunc(FECHA_INSTALACION) >= trunc(:FECHA_RETIRO)
                    ) ORDER BY FECHA_INSTALACION ASC
                  )
                ) WHERE IDT = 1
              ' INTO v_idopera,v_f_ini_ope,v_f_instala USING D_CONTRATO, dta.FECHA_RETIRO,dta.FECHA_RETIRO,D_CONTRATO, dta.FECHA_RETIRO,dta.FECHA_RETIRO;
             EXCEPTION
                WHEN NO_DATA_FOUND then
                  v_idopera :=0;
             end;
            if v_idopera >=1 then
              --validacion fecha novedad
              v_f_ini_ope := v_f_instala;
              if dta.FECHA_RETIRO is not null then
                if v_f_instala &lt; dta.FECHA_RETIRO then
                  v_FECHA_NOVEDAD := dta.FECHA_RETIRO+1;
                  v_f_ini_ope := dta.FECHA_RETIRO+1;
                end if;
                if v_f_instala > dta.FECHA_RETIRO then
                  v_FECHA_NOVEDAD := v_f_ini_ope;
                end if;
              end if;

              if v_FECHA_NOVEDAD is null then
                if v_f_ini_ope &lt; dta.FECHA_RETIRO then
                  v_FECHA_NOVEDAD := dta.FECHA_RETIRO+1;
                else 
                  v_FECHA_NOVEDAD := v_f_ini_ope;
                end if; 
              end if;
              update MINTIC_OPERACIONES_ODI set ID_BENEFICIARIO = dta.ID_BENEFICIARIO ,NOVEDAD='INGRESO',FECHA_NOVEDAD= v_FECHA_NOVEDAD,FECHA_INI_OPERA = v_f_ini_ope where CUENTA = v_idopera;
              --update MINTIC_OPERACIONES_ODI set NOVEDAD='RETIRO', FECHA_NOVEDAD = dta.FECHA_RETIRO where ROWID=dta.ID_OPERACIONES;
             COMMIT;
             else
                INSERT INTO MINTIC_PROCESADAS ( ID_OPERACION, DESCRIPCION )  VALUES ( v_idopera,'No se encontraron ID_BENEFICIARIO de remplazo, para la cuenta: ' || dta.CUENTA || ' Ciudad: ' ||dta.CIUDAD || ' FECHA_NOVEDAD: ' || dta.FECHA_RETIRO || ' CONTRATO: ' || D_CONTRATO);
             end if;
          end if;
       --insert log
       if v_idopera >=1  then
        INSERT INTO MINTIC_LOG_PROCESO ( CUENTA_RETIRO, ID_BENEFICIARIO, CUENTA_INGRESO ) VALUES ( dta.CUENTA, dta.ID_BENEFICIARIO, v_idopera);
        UPDATE MINTIC_OPERACIONES_ODI SET REMPLAZO = NULL WHERE CUENTA =  dta.CUENTA;
       end if;
      end loop;
      COMMIT;
      end;
        BEGIN 
          FOR E IN (
            SELECT CC.ROWID IDT,
                BB.CUENTA,
                BB.ID_BENEFICIARIO,
                to_number(BB.CONTR_APOR_MINTIC) CONTR_APOR_MINTIC
              FROM MINTIC_OPERACIONES_ODI BB
              INNER JOIN MINTIC_BENIF CC
              ON CC.CONTRATO = to_number(BB.CONTR_APOR_MINTIC) and CC.ID_BENEFICIARIO = BB.ID_BENEFICIARIO
              WHERE BB.ID_BENEFICIARIO IS NOT NULL
            AND to_number(BB.CONTR_APOR_MINTIC) = D_CONTRATO
            ) LOOP
                update MINTIC_BENIF set ASIGNADO = 1 WHERE ROWID = E.IDT;
              END LOOP;
              COMMIT;
        END;
        BEGIN

              FOR A IN (
                  SELECT ROWID IDT,
                    ID_BENEFICIARIO,
                    to_number(CONTR_APOR_MINTIC) CONTR_APOR_MINTIC
                  FROM MINTIC_OPERACIONES_ODI 
                  WHERE ESTADO_FONTIC = 'APROBADO'
                  AND NVL(ID_BENEFICIARIO,0) &lt;=0
                  AND to_number(CONTR_APOR_MINTIC) = D_CONTRATO
                  ORDER BY ESTADO,FECHA_INI_OPERA asc
                ) LOOP

                  BEGIN
                    EXECUTE IMMEDIATE 'SELECT ID_BENIF ,ID_BENEFICIARIO FROM (
                      SELECT ROWNUM IDDT,ID_BENIF,ID_BENEFICIARIO FROM(
                      SELECT ID_BENEFICIARIO, ID_MINTIC_BENIF ID_BENIF FROM MINTIC_BENIF WHERE ASIGNADO =0 AND CONTRATO = :D_CONTRATO
                      ORDER BY ID_BENEFICIARIO)) WHERE IDDT =1' INTO V_IDB_CONTRC,V_INI_CONTRC USING D_CONTRATO;
                    EXCEPTION 
                      WHEN NO_DATA_FOUND THEN
                        V_INI_CONTRC := NULL;
                  END;
                  IF V_INI_CONTRC IS NOT NULL THEN
                    UPDATE MINTIC_OPERACIONES_ODI set ID_BENEFICIARIO = V_INI_CONTRC where rowid = A.IDT;
                    UPDATE MINTIC_BENIF SET ASIGNADO = 2,FECHA_MODIFICACION = sysdate WHERE ID_MINTIC_BENIF = V_IDB_CONTRC;
                  END IF;

              END LOOP;
              COMMIT;
        END;
 end;

</pre>
</div>
</div>
</div>
</body>
</html>
