<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="TFS_INSERT_OT_SP/report.js" type="text/javascript"></script>
<link href="TFS_INSERT_OT_SP/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">TFS_INSERT_OT_SP</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#"TFS_INSERT_OT_SP"">"TFS_INSERT_OT_SP"</A></B>( VAR_ID_SOLICITUD IN NUMBER , VAR_ID_FABRICA IN NUMBER , VAR_ID_INGENIERO IN NUMBER DEFAULT 0 , VAR_FASE IN NUMBER , VAR_TIPO_GESTION IN NUMBER , VAR_NRO_BRIEF IN NUMBER , VAR_ID_USUARIO IN NUMBER , VAR_ID_TALLA IN NUMBER , VAR_VALOR_HORA IN NUMBER , VAR_NRO_LP IN NUMBER , VAR_NRO_ORDEN_TRABAJO IN NUMBER , VAR_HORAS_ESTIMADAS IN NUMBER , VAR_FACTOR IN NUMBER ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME=""TFS_INSERT_OT_SP""></A>
<H3>"TFS_INSERT_OT_SP"</H3><PRE>          <B>"TFS_INSERT_OT_SP"</B>( VAR_ID_SOLICITUD IN NUMBER , VAR_ID_FABRICA IN NUMBER , VAR_ID_INGENIERO IN NUMBER DEFAULT 0 , VAR_FASE IN NUMBER , VAR_TIPO_GESTION IN NUMBER , VAR_NRO_BRIEF IN NUMBER , VAR_ID_USUARIO IN NUMBER , VAR_ID_TALLA IN NUMBER , VAR_VALOR_HORA IN NUMBER , VAR_NRO_LP IN NUMBER , VAR_NRO_ORDEN_TRABAJO IN NUMBER , VAR_HORAS_ESTIMADAS IN NUMBER , VAR_FACTOR IN NUMBER ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>PDB_CRONUS</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>TFS_INSERT_OT_SP</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>80330</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>13/07/22</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>17/08/22</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2022-08-17:05:13:30</td>
</tr>
<tr>
<td>STATUS</td>
<td>VALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>N</td>
</tr>
<tr>
<td>DEFAULT_COLLATION</td>
<td>USING_NLS_COMP</td>
</tr>
<tr>
<td>DUPLICATED</td>
<td>N</td>
</tr>
<tr>
<td>SHARDED</td>
<td>N</td>
</tr>
<tr>
<td>CREATED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>CREATED_VSNID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_VSNID</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PROCEDURE              "TFS_INSERT_OT_SP" 
(
  VAR_ID_SOLICITUD IN NUMBER 
, VAR_ID_FABRICA IN NUMBER 
, VAR_ID_INGENIERO IN NUMBER DEFAULT 0 
, VAR_FASE IN NUMBER 
, VAR_TIPO_GESTION IN NUMBER 
, VAR_NRO_BRIEF IN NUMBER
, VAR_ID_USUARIO IN NUMBER
, VAR_ID_TALLA IN NUMBER
, VAR_VALOR_HORA IN NUMBER
, VAR_NRO_LP IN NUMBER
, VAR_NRO_ORDEN_TRABAJO IN NUMBER
, VAR_HORAS_ESTIMADAS IN NUMBER
, VAR_FACTOR IN NUMBER
) AS
    Codigo_Ingeniero VARCHAR(5):='';
    Codigo_Fabrica VARCHAR(5):='';
    Codigo_LineaProducto VARCHAR(5):='';
    Orden_Trabajo VARCHAR(30):='';
    fecha_actual VARCHAR(4):='';
    generar_ceros VARCHAR(4):='';
    cantidadOts INTEGER := 0;
    var_idOT INTEGER := 0;
    var_maxIdEntregasOT INTEGER := 0;
    var_validarIDEntregable INTEGER := -2;
    var_calculoValorDinero DECIMAL(10,2):= 0;
    var_calculoValorHoras DECIMAL(10,2):= 0;
    cursorEntregas TFS_ENTREGAS%ROWTYPE;
BEGIN    
    SELECT U1.SIGLA_FACTURACION INTO Codigo_Fabrica FROM TFS_FABRICAS_LPS A INNER JOIN TFS_FABRICAS U1 ON U1.ID_FABRICA =  A.ID_FABRICA WHERE A.ID_FABRICA_LP = VAR_ID_FABRICA;
    SELECT U2.SIGLA_FACTURACION INTO Codigo_LineaProducto FROM TFS_FABRICAS_LPS A INNER JOIN TFS_LINEAS_PRODUCTOS U2 ON U2.ID_LINEA_PRODUCTO =  A.ID_LINEA_PRODUCTO WHERE A.ID_FABRICA_LP = VAR_ID_FABRICA;
    IF VAR_TIPO_GESTION = 0 THEN
        Codigo_Ingeniero := 'XYZ';
    ELSE
       SELECT SIGLA_FACTURACION INTO Codigo_Ingeniero FROM TFS_INGENIEROS WHERE ID_INGENIERO = VAR_ID_INGENIERO;
    END IF;
    SELECT TO_CHAR(CURRENT_DATE, 'MMYY') INTO fecha_actual FROM dual;
    FOR i IN 1..(5 - length(VAR_NRO_BRIEF)) LOOP
      generar_ceros:= '0'||generar_ceros;
    END LOOP;
        Orden_Trabajo := 'OT'||generar_ceros||VAR_NRO_BRIEF||'-'||VAR_FASE||'-'||Codigo_Fabrica||'-'||Codigo_LineaProducto||Codigo_Ingeniero||'-'||fecha_actual;     
        INSERT INTO TFS_OTS(ID_OT,ID_SOLICITUD,OT,ID_USUARIO)VALUES(PDB_CRONUS.TFS_OTS_SQ.NEXTVAL,VAR_ID_SOLICITUD,Orden_Trabajo,VAR_ID_USUARIO);
        SELECT ID_OT INTO var_idOT FROM TFS_OTS WHERE ID_SOLICITUD = VAR_ID_SOLICITUD;
            FOR cursorEntregas IN ( SELECT A.ID_ENTREGA, A.DESCRIPCION DESCRIPCION_ENTR, A.PORCENTAJE_FACTURACION, B.ID_DOCUMENTO, B.DESCRIPCION DESCRIPCION_DOC, B.OBLIGATORIO FROM TFS_ENTREGAS A INNER JOIN TFS_DOCUMENTOS B ON A.ID_ENTREGA = B.ID_ENTREGA WHERE A.ID_TALLA = VAR_ID_TALLA ORDER BY A.ID_ENTREGA) LOOP
                IF (var_validarIDEntregable = -2 OR var_validarIDEntregable!=cursorEntregas.ID_ENTREGA) THEN        
                    IF VAR_TIPO_GESTION = 0 THEN
                        var_calculoValorDinero := (VAR_VALOR_HORA * VAR_HORAS_ESTIMADAS) * (cursorEntregas.PORCENTAJE_FACTURACION / 100);
                    ELSE
                        var_calculoValorDinero := ((VAR_VALOR_HORA * VAR_FACTOR) * VAR_HORAS_ESTIMADAS) * (cursorEntregas.PORCENTAJE_FACTURACION / 100);
                    END IF;                    
                    var_calculoValorHoras := VAR_HORAS_ESTIMADAS * (cursorEntregas.PORCENTAJE_FACTURACION / 100);
                    INSERT INTO TFS_OTS_ENTREGABLES(ID_OT_ENTREGABLE,ID_OT, DESCRIPCION_ENTREGABLE, PORCENTAJE_FACTURACION,VALOR_HORAS,VALOR_DINERO,ID_USUARIO)VALUES(PDB_CRONUS.TFS_OTS_ENTREGABLES_SQ.NEXTVAL,var_idOT,cursorEntregas.DESCRIPCION_ENTR,cursorEntregas.PORCENTAJE_FACTURACION,var_calculoValorHoras,var_calculoValorDinero,VAR_ID_USUARIO);                    
                    var_validarIDEntregable := cursorEntregas.ID_ENTREGA;
                END IF;                 
                SELECT MAX(ID_OT_ENTREGABLE) INTO var_maxIdEntregasOT FROM TFS_OTS_ENTREGABLES;                
                INSERT INTO TFS_OTS_DOCUMENTOS(ID_OT_DOCUMENTO,ID_OT_ENTREGABLE, DESCRIPCION_DOCUMENTO, OBLIGATORIO, ESTADO_DOCUMENTO,ID_USUARIO)VALUES(PDB_CRONUS.TFS_OTS_DOCUMENTOS_SQ.NEXTVAL,var_maxIdEntregasOT,cursorEntregas.DESCRIPCION_DOC,cursorEntregas.OBLIGATORIO,'Pendiente',VAR_ID_USUARIO);                
            END LOOP;
  NULL;
END TFS_INSERT_OT_SP;</pre>
</div>
</div>
</div>
</body>
</html>
