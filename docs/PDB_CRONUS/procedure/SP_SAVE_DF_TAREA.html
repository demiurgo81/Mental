<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="SP_SAVE_DF_TAREA/report.js" type="text/javascript"></script>
<link href="SP_SAVE_DF_TAREA/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">SP_SAVE_DF_TAREA</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#"SP_SAVE_DF_TAREA"">"SP_SAVE_DF_TAREA"</A></B>( P_ID IN NUMBER , P_CODTAREAPADRE IN NUMBER , P_CODTAREATIPO IN NUMBER , P_CODTAREAESTADO IN NUMBER , P_CODEMPLEADOCREO IN NUMBER , P_CODEMPLEADOASIGNADO IN NUMBER , P_CODPROYECTO IN NUMBER , P_JERARQUIA IN VARCHAR2 , P_NOMBRE IN VARCHAR2 , P_NIVEL IN NUMBER , P_DESCRIPCION IN VARCHAR2 , P_FECHAINIESTIMADA IN DATE , P_FECHAFINESTIMADA IN DATE , P_FECHAINIREAL IN DATE , P_FECHAFINREAL IN DATE , P_TIEMPOESTIMADO IN NUMBER , P_TIEMPOREAL IN NUMBER , P_ESLOGRO IN NUMBER , P_ESTADO IN VARCHAR2 , P_FECHA_COMPROMISO IN TIMESTAMP , P_FECHA_SOLICITUD IN TIMESTAMP , P_DESCRIPCION_SOLICITUD IN VARCHAR2 , P_CODLINEAPRODUCTO IN NUMBER , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER , V_S_MENSAJE OUT VARCHAR2 ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME=""SP_SAVE_DF_TAREA""></A>
<H3>"SP_SAVE_DF_TAREA"</H3><PRE>          <B>"SP_SAVE_DF_TAREA"</B>( P_ID IN NUMBER , P_CODTAREAPADRE IN NUMBER , P_CODTAREATIPO IN NUMBER , P_CODTAREAESTADO IN NUMBER , P_CODEMPLEADOCREO IN NUMBER , P_CODEMPLEADOASIGNADO IN NUMBER , P_CODPROYECTO IN NUMBER , P_JERARQUIA IN VARCHAR2 , P_NOMBRE IN VARCHAR2 , P_NIVEL IN NUMBER , P_DESCRIPCION IN VARCHAR2 , P_FECHAINIESTIMADA IN DATE , P_FECHAFINESTIMADA IN DATE , P_FECHAINIREAL IN DATE , P_FECHAFINREAL IN DATE , P_TIEMPOESTIMADO IN NUMBER , P_TIEMPOREAL IN NUMBER , P_ESLOGRO IN NUMBER , P_ESTADO IN VARCHAR2 , P_FECHA_COMPROMISO IN TIMESTAMP , P_FECHA_SOLICITUD IN TIMESTAMP , P_DESCRIPCION_SOLICITUD IN VARCHAR2 , P_CODLINEAPRODUCTO IN NUMBER , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER , V_S_MENSAJE OUT VARCHAR2 ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>PDB_CRONUS</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>SP_SAVE_DF_TAREA</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>93841</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>16/07/24</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>30/05/25</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2025-05-30:19:28:08</td>
</tr>
<tr>
<td>STATUS</td>
<td>VALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>N</td>
</tr>
<tr>
<td>DEFAULT_COLLATION</td>
<td>USING_NLS_COMP</td>
</tr>
<tr>
<td>DUPLICATED</td>
<td>N</td>
</tr>
<tr>
<td>SHARDED</td>
<td>N</td>
</tr>
<tr>
<td>CREATED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>CREATED_VSNID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_VSNID</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PROCEDURE "SP_SAVE_DF_TAREA" (
    P_ID IN NUMBER,
    P_CODTAREAPADRE IN NUMBER,
    P_CODTAREATIPO IN NUMBER,
    P_CODTAREAESTADO IN NUMBER,
    P_CODEMPLEADOCREO IN NUMBER,
    P_CODEMPLEADOASIGNADO IN NUMBER,
    P_CODPROYECTO IN NUMBER,
    P_JERARQUIA IN VARCHAR2,
    P_NOMBRE IN VARCHAR2,
    P_NIVEL IN NUMBER,
    P_DESCRIPCION IN VARCHAR2,
    P_FECHAINIESTIMADA IN DATE,
    P_FECHAFINESTIMADA IN DATE,
    P_FECHAINIREAL IN DATE,
    P_FECHAFINREAL IN DATE,
    P_TIEMPOESTIMADO IN NUMBER,
    P_TIEMPOREAL IN NUMBER,
    P_ESLOGRO IN NUMBER,
    P_ESTADO IN VARCHAR2,
    P_FECHA_COMPROMISO IN TIMESTAMP,
    P_FECHA_SOLICITUD IN TIMESTAMP,
    P_DESCRIPCION_SOLICITUD IN VARCHAR2,
    P_CODLINEAPRODUCTO IN NUMBER,
	V_S_RESPUESTA OUT VARCHAR2,
    V_S_CODIGO OUT NUMBER,
	V_S_MENSAJE OUT VARCHAR2
) AS
    V_ES_INSERT BOOLEAN;
    V_CANT_DIGITOS_POR_NIVEL NUMBER := 10;
    V_JERARQUIA VARCHAR2(1000);
	V_NIVEL NUMBER := 0;
    V_ID_INSERT NUMBER;
    V_FECHAFINREAL DATE;
    V_FECHAINIREAL DATE;
    V_CODTAREAPADRE NUMBER;
    V_CODEMPLEADOASIGNADO NUMBER;
BEGIN

	BEGIN
    V_ES_INSERT := (P_ID IS NULL OR P_ID &lt;= 0);
    DBMS_OUTPUT.PUT_LINE('Dato insert ' || P_ID);
    
    IF P_CODEMPLEADOASIGNADO = 0  THEN
        V_CODEMPLEADOASIGNADO := NULL;
    ELSE 
        V_CODEMPLEADOASIGNADO := P_CODEMPLEADOASIGNADO;
    END IF;
    
	-- BUSCAR  TAREA PADRE SI ES EL CASO PARA EL NIVEL Y LA JERARQUIA
	IF P_CODTAREAPADRE > 0 THEN 
        DBMS_OUTPUT.PUT_LINE('Hace consulta de tareapadre');

        V_CODTAREAPADRE := P_CODTAREAPADRE;

		SELECT NIVEL, JERARQUIA
		INTO V_NIVEL, V_JERARQUIA
		FROM DF_TAREA t WHERE t.ID = P_CODTAREAPADRE;
    ELSE  
        V_CODTAREAPADRE := NULL;
	END IF;

    -- Guardar la entidad
    IF V_ES_INSERT THEN
        DBMS_OUTPUT.PUT_LINE('Llega a hacer el insert');
        DBMS_OUTPUT.PUT_LINE('Hace consulta de tareapadre V_CODTAREAPADRE: ' || V_CODTAREAPADRE);
        
        INSERT INTO DF_TAREA (CODTAREAPADRE, CODTAREATIPO, CODTAREAESTADO, CODEMPLEADOCREO, CODEMPLEADOASIGNADO, CODPROYECTO, JERARQUIA, NOMBRE,
            NIVEL, DESCRIPCION, FECHAINIESTIMADA, FECHAFINESTIMADA, TIEMPOESTIMADO, 
            ESLOGRO, ESTADO, DESCRIPCION_SOLICITUD, CODLINEAPRODUCTO) 
        VALUES (V_CODTAREAPADRE, P_CODTAREATIPO, P_CODTAREAESTADO, P_CODEMPLEADOCREO, V_CODEMPLEADOASIGNADO, P_CODPROYECTO, P_JERARQUIA, P_NOMBRE,
            V_NIVEL+1, P_DESCRIPCION, P_FECHAINIESTIMADA, P_FECHAFINESTIMADA, P_TIEMPOESTIMADO, 
            P_ESLOGRO, 'A', P_DESCRIPCION_SOLICITUD, P_CODLINEAPRODUCTO) 
        RETURNING ID INTO V_ID_INSERT;

	-- Actualizar la jerarquía y el nivel si es una inserción	
    DBMS_OUTPUT.PUT_LINE(' V_JERARQUIA: ' || V_JERARQUIA);
	UPDATE DF_TAREA 
        SET JERARQUIA = V_JERARQUIA || LPAD(V_ID_INSERT, LENGTH(TO_CHAR(V_ID_INSERT))+5, '0') 
        WHERE ID=V_ID_INSERT;

    V_S_MENSAJE := 'Tarea creada Exitosamente con el ID';

    ELSE

        IF TO_CHAR(P_FECHAINIREAL, 'YYYY-MM-DD') = '1969-12-31' THEN
            V_FECHAINIREAL := null;
        ELSE
            V_FECHAINIREAL := P_FECHAINIREAL;
        END IF;

        IF TO_CHAR(P_FECHAFINREAL, 'YYYY-MM-DD') = '1969-12-31' THEN
            V_FECHAFINREAL := null;
        ELSE 
            V_FECHAFINREAL := P_FECHAFINREAL;
        END IF;
        -- Actualizar el registro existente
        
        IF V_CODTAREAPADRE IS NULL THEN
            SELECT NIVEL, JERARQUIA
                INTO V_NIVEL, V_JERARQUIA
                FROM DF_TAREA t WHERE t.ID = P_ID;
        END IF;
        
        UPDATE DF_TAREA
        SET
            CODTAREAPADRE = V_CODTAREAPADRE,
            CODTAREATIPO = P_CODTAREATIPO,
            CODTAREAESTADO = P_CODTAREAESTADO,
            CODEMPLEADOCREO = P_CODEMPLEADOCREO,
            CODEMPLEADOASIGNADO = V_CODEMPLEADOASIGNADO,
            CODPROYECTO = P_CODPROYECTO,
            JERARQUIA = V_JERARQUIA,
            NOMBRE = P_NOMBRE,
            NIVEL = V_NIVEL,
            DESCRIPCION = P_DESCRIPCION,
            FECHAINIESTIMADA = P_FECHAINIESTIMADA,
            FECHAFINESTIMADA = P_FECHAFINESTIMADA,
            FECHAINIREAL = V_FECHAINIREAL,
            FECHAFINREAL = V_FECHAFINREAL,
            TIEMPOESTIMADO = P_TIEMPOESTIMADO,
            TIEMPOREAL = P_TIEMPOREAL,
            ESLOGRO = P_ESLOGRO,
            ESTADO = P_ESTADO,
            DESCRIPCION_SOLICITUD = P_DESCRIPCION_SOLICITUD
        WHERE ID = P_ID;

        V_ID_INSERT := P_ID;
        V_S_MENSAJE := 'Tarea modificada Exitosamente con el ID';

    END IF;

    -- Devolver la entidad
	V_S_CODIGO    := 200;

	V_S_RESPUESTA := V_ID_INSERT;

    EXCEPTION
            WHEN NO_DATA_FOUND THEN
			ROLLBACK;
            V_S_CODIGO    := 500;
            V_S_MENSAJE := 'No Fue posible crear la tarea';
			V_S_RESPUESTA := 'ERROR: ' || SQLERRM;
            RAISE;
    END;
    COMMIT;
END SP_SAVE_DF_TAREA;</pre>
</div>
</div>
</div>
</body>
</html>
