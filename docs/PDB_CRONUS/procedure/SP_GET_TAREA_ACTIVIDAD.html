<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="SP_GET_TAREA_ACTIVIDAD/report.js" type="text/javascript"></script>
<link href="SP_GET_TAREA_ACTIVIDAD/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">SP_GET_TAREA_ACTIVIDAD</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P></P><HR><P></P><A NAME="method_summary"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Summary</B></FONT></TD><TR CLASS="TableRowColor"><TD WIDTH="1%" VALIGN="top" ALIGN="right"><FONT SIZE="-1"><CODE>&nbsp;</CODE></FONT></TD><TD><CODE><B><A HREF="#SP_GET_TAREA_ACTIVIDAD">SP_GET_TAREA_ACTIVIDAD</A></B>( P_CODPROYECTO IN NUMBER , P_CODPROVEEDOR IN NUMBER , P_CODPERSONA IN NUMBER , P_FECHAINI IN DATE , P_FECHAFIN IN DATE , P_CURSOR_GET_TAREA_ACTIVIDAD OUT SYS_REFCURSOR , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER ) </CODE><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
</TABLE>
<P></P><A NAME="method_detail"></A><TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="3" BORDER="1"><TR CLASS="TableHeadingColor"><TD COLSPAN="2"><FONT SIZE="+2"><B>Method Detail</B></FONT></TD></TABLE><A NAME="SP_GET_TAREA_ACTIVIDAD"></A>
<H3>SP_GET_TAREA_ACTIVIDAD</H3><PRE>          <B>SP_GET_TAREA_ACTIVIDAD</B>( P_CODPROYECTO IN NUMBER , P_CODPROVEEDOR IN NUMBER , P_CODPERSONA IN NUMBER , P_FECHAINI IN DATE , P_FECHAFIN IN DATE , P_CURSOR_GET_TAREA_ACTIVIDAD OUT SYS_REFCURSOR , V_S_RESPUESTA OUT VARCHAR2 , V_S_CODIGO OUT NUMBER ) </PRE><DL>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<DD><DL></DL></DD></DL><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>PDB_CRONUS</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>SP_GET_TAREA_ACTIVIDAD</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>96342</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PROCEDURE</td>
</tr>
<tr>
<td>CREATED</td>
<td>18/09/24</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>20/05/25</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2025-05-20:09:43:41</td>
</tr>
<tr>
<td>STATUS</td>
<td>INVALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>1</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>N</td>
</tr>
<tr>
<td>DEFAULT_COLLATION</td>
<td>USING_NLS_COMP</td>
</tr>
<tr>
<td>DUPLICATED</td>
<td>N</td>
</tr>
<tr>
<td>SHARDED</td>
<td>N</td>
</tr>
<tr>
<td>CREATED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>CREATED_VSNID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_APPID</td>
<td>null</td>
</tr>
<tr>
<td>MODIFIED_VSNID</td>
<td>null</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PROCEDURE SP_GET_TAREA_ACTIVIDAD(
    P_CODPROYECTO IN NUMBER,
    P_CODPROVEEDOR IN NUMBER,
    P_CODPERSONA IN NUMBER,
    P_FECHAINI IN DATE,
    P_FECHAFIN IN DATE,
    P_CURSOR_GET_TAREA_ACTIVIDAD OUT SYS_REFCURSOR,
    V_S_RESPUESTA OUT VARCHAR2,
    V_S_CODIGO OUT NUMBER
)
AS
BEGIN
    BEGIN
        -- ABRIR EL REF CURSOR CON LA CONSULTA
        OPEN P_CURSOR_GET_TAREA_ACTIVIDAD FOR
        WITH TAREASPROCESADAS AS (
               SELECT T.ID,
                      T.FECHAINIREAL, 
                      T.FECHAINIESTIMADA,
                      T.FECHAFINREAL, 
                      T.FECHAFINESTIMADA,
                      T.CODTAREAPADRE,
                      T.CODPROYECTO,
                      T.CODEMPLEADOASIGNADO,
                      T.CODEMPLEADOCREO,
                      T.NOMBRE,
                      T.TIEMPOESTIMADO,
                      T.TIEMPOREAL,
                      T.CODTAREAESTADO,
                      T.CODTAREATIPO,
                      NVL(T.TIEMPOESTIMADO, 9) / 9 AS DURATION,
                      NVL(T.CODTAREAPADRE, T.CODPROYECTO * -1) AS PARENT
               FROM DF_TAREA T
               WHERE T.ESTADO = 'A'
                 AND T.FECHAINIESTIMADA &lt;= P_FECHAFIN
                 AND T.FECHAFINESTIMADA >= P_FECHAINI
                 AND (P_CODPERSONA = 0 OR T.CODEMPLEADOASIGNADO IN (
                    SELECT EM.ID FROM DF_EMPLEADO EM
                    WHERE EM.CODPERSONA = P_CODPERSONA AND VIGENTE = 1
                 ))
            ),
            EMPLEADOSYPERSONAS AS (
               SELECT EA.ID AS EMPLEADO_ID,
                      EA.CODPERSONA,
                      EA.CODPROVEEDOR,
                      P.NOMCOMPLETO AS EMPLEADOASIGNADO
               FROM DF_EMPLEADO EA
               INNER JOIN DF_PERSONA P ON P.ID = EA.CODPERSONA
            ),
            PROYECTOS_FILTRADOS AS (
               SELECT DISTINCT P.ID,
                      P.NOMBRE,
                      P.FECHAINICIO,
                      P.FECHAFIN
               FROM DF_PROYECTO P
               INNER  JOIN DF_PRESUPUESTO PRE ON P.CODPRESUPUESTO = PRE.ID
               INNER  JOIN DF_TAREA T ON T.CODPROYECTO = P.ID
               WHERE PRE.VIGENCIA BETWEEN EXTRACT(YEAR FROM SYSDATE) - 1 AND EXTRACT(YEAR FROM SYSDATE)
                 AND T.ESTADO = 'A'
                 AND (P_CODPERSONA = 0 OR T.CODEMPLEADOASIGNADO IN (
                    SELECT EM.ID FROM DF_EMPLEADO EM
                    WHERE EM.CODPERSONA = P_CODPERSONA AND VIGENTE = 1
                 ))
                 AND T.FECHAINIESTIMADA &lt;= P_FECHAFIN
                 AND T.FECHAFINESTIMADA >= P_FECHAINI
            )
            SELECT TP.ID AS ID,
                   TP.NOMBRE AS TEXT,
                   TP.FECHAINIESTIMADA AS START_DATE,
                   TP.DURATION,
                   CASE
                       WHEN TP.TIEMPOESTIMADO IS NOT NULL AND TP.TIEMPOREAL IS NOT NULL AND TP.TIEMPOESTIMADO >= TP.TIEMPOREAL
                           THEN ROUND(TP.TIEMPOREAL / TP.TIEMPOESTIMADO, 2)
                       WHEN TP.TIEMPOESTIMADO IS NOT NULL AND TP.TIEMPOREAL IS NOT NULL AND TP.TIEMPOESTIMADO &lt; TP.TIEMPOREAL
                           THEN 1
                       ELSE 0
                   END AS PROGRESS,
                   TP.PARENT,
                   TP.CODPROYECTO,
                   EY.CODPROVEEDOR,
                   EY.CODPERSONA AS CODPERSONA,
                   EY.CODPERSONA AS CODPERSONAASIGNADO,
                   EY.EMPLEADOASIGNADO,
                   ECREO.CODPERSONA AS CODPERSONACREO,
                   TP.FECHAINIESTIMADA,
                   TP.FECHAFINESTIMADA,
                   TP.TIEMPOESTIMADO,
                   TP.FECHAINIREAL,
                   TP.FECHAFINREAL,
                   TP.TIEMPOREAL,
                   TT.COLOR,
                   '#0000003B' AS PROGRESSCOLOR,
                   NVL(TP.FECHAINIESTIMADA, TP.FECHAINIREAL) AS FECHAINICIO,
                   NVL(TP.FECHAFINESTIMADA, TP.FECHAFINREAL) AS FECHAFIN,
                   TP.CODTAREAESTADO AS ESTADOTAREA,
                   'task' AS TYPE,
                   0 as OPEN
            FROM TAREASPROCESADAS TP
            INNER  JOIN EMPLEADOSYPERSONAS EY ON EY.EMPLEADO_ID = TP.CODEMPLEADOASIGNADO
            INNER  JOIN EMPLEADOSYPERSONAS ECREO ON ECREO.EMPLEADO_ID = TP.CODEMPLEADOCREO
            INNER  JOIN DF_TAREATIPO TT ON TT.ID = TP.CODTAREATIPO
            WHERE (P_CODPROVEEDOR = 0 OR EY.CODPROVEEDOR = P_CODPROVEEDOR)
              AND (P_CODPERSONA = 0 OR EY.CODPERSONA = P_CODPERSONA)
              AND (P_CODPROYECTO = 0 OR TP.CODPROYECTO = P_CODPROYECTO)
            
            UNION ALL
            
            SELECT (P.ID * -1) AS ID,
                   P.NOMBRE AS TEXT,
                   TO_DATE(P.FECHAINICIO, 'DD/MM/YYYY') AS START_DATE,
                   (P.FECHAFIN - P.FECHAINICIO) AS DURATION,
                   0 AS PROGRESS,
                   CAST(NULL AS NUMBER) AS PARENT,
                   P.ID AS CODPROYECTO,
                   NULL AS CODPROVEEDOR,
                   NULL AS CODPERSONA,
                   NULL AS CODPERSONAASIGNADO,
                   NULL AS EMPLEADOASIGNADO,
                   NULL AS CODPERSONACREO,
                   NULL AS FECHAINIESTIMADA,
                   NULL AS FECHAFINESTIMADA,
                   NULL AS TIEMPOESTIMADO,
                   NULL AS FECHAINIREAL,
                   NULL AS FECHAFINREAL,
                   NULL AS TIEMPOREAL,
                   NULL AS COLOR,
                   '#0000003B' AS PROGRESSCOLOR,
                   P.FECHAINICIO AS FECHAINICIO,
                   P.FECHAFIN AS FECHAFIN,
                   NULL AS ESTADOTAREA,
                   'project' AS TYPE,
                   0 as OPEN
            FROM PROYECTOS_FILTRADOS P
            WHERE (P_CODPROYECTO = 0 OR P.ID = P_CODPROYECTO);

        V_S_CODIGO := 200;
        V_S_RESPUESTA := 'Retorno de datos completo';

    EXCEPTION
        WHEN OTHERS THEN
            V_S_CODIGO := 500;
            V_S_RESPUESTA := 'ERROR: ' || SQLERRM;
    END;
END SP_GET_TAREA_ACTIVIDAD;</pre>
</div>
</div>
</div>
</body>
</html>
